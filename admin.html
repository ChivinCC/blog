<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>åå°ç®¡ç† â€” ç™¾å€æœºä¼šæ”»ç•¥</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600;700&family=Noto+Sans+SC:wght@300;400;500&display=swap');

:root {
  --bg:      #0a0a0f;
  --sf:      #13131a;
  --sf2:     #1c1c26;
  --bd:      rgba(255,255,255,0.08);
  --bd2:     rgba(255,255,255,0.14);
  --t1:      #f0f0f5;
  --t2:      #9090a8;
  --t3:      #5a5a72;
  --ac:      #4f8ef7;
  --ac-glow: rgba(79,142,247,0.25);
  --red:     #ff453a;
  --red-bg:  rgba(255,69,58,0.12);
  --grn:     #30d158;
  --grn-bg:  rgba(48,209,88,0.12);
  --r:       14px;
  --rs:      8px;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Noto Sans SC', -apple-system, sans-serif; background: var(--bg); color: var(--t1); min-height: 100vh; -webkit-font-smoothing: antialiased; }

/* â”€â”€ LOGIN â”€â”€ */
#loginScreen {
  position: fixed; inset: 0;
  display: flex; align-items: center; justify-content: center;
  background: var(--bg); z-index: 1000;
  animation: fadeIn .4s ease;
}
@keyframes fadeIn { from { opacity:0; } to { opacity:1; } }

.login-card {
  width: 380px; background: var(--sf);
  border: 1px solid var(--bd2); border-radius: 20px;
  padding: 48px 40px;
  box-shadow: 0 0 80px rgba(79,142,247,.08), 0 40px 80px rgba(0,0,0,.5);
}
.login-logo { text-align: center; margin-bottom: 36px; }
.login-icon {
  width: 56px; height: 56px;
  background: linear-gradient(135deg,#4f8ef7,#7b5af5);
  border-radius: 16px; display: flex; align-items: center; justify-content: center;
  margin: 0 auto 14px; box-shadow: 0 8px 24px rgba(79,142,247,.35);
}
.login-icon svg { width: 28px; height: 28px; color:#fff; }
.login-logo h1 { font-family:'Noto Serif SC',serif; font-size:18px; font-weight:700; color:var(--t1); }
.login-logo p { font-size:13px; color:var(--t2); margin-top:4px; }

.fg { margin-bottom:16px; }
.fg label { display:block; font-size:12px; font-weight:500; color:var(--t2); margin-bottom:8px; text-transform:uppercase; letter-spacing:.06em; }
.fg input {
  width:100%; padding:12px 16px;
  background:var(--sf2); border:1px solid var(--bd2); border-radius:var(--rs);
  color:var(--t1); font-size:15px; font-family:inherit; outline:none;
  transition:border-color .2s, box-shadow .2s;
}
.fg input:focus { border-color:var(--ac); box-shadow:0 0 0 3px var(--ac-glow); }

.btn-login {
  width:100%; padding:13px;
  background:linear-gradient(135deg,#4f8ef7,#7b5af5);
  border:none; border-radius:var(--rs); color:#fff;
  font-size:15px; font-weight:500; font-family:inherit; cursor:pointer;
  margin-top:8px; transition:opacity .2s, transform .15s;
  box-shadow:0 4px 16px rgba(79,142,247,.4);
}
.btn-login:hover { opacity:.9; transform:translateY(-1px); }
.btn-login:active { transform:none; }
.login-err { font-size:13px; color:var(--red); text-align:center; margin-top:12px; min-height:20px; }

/* â”€â”€ APP LAYOUT â”€â”€ */
#adminApp { display:none; min-height:100vh; }
.layout { display:flex; min-height:100vh; }

/* Sidebar */
.sidebar {
  width:220px; background:var(--sf); border-right:1px solid var(--bd);
  display:flex; flex-direction:column; flex-shrink:0;
  position:sticky; top:0; height:100vh; overflow-y:auto;
}
.sb-brand { padding:24px 20px 20px; border-bottom:1px solid var(--bd); }
.sb-brand-name { font-family:'Noto Serif SC',serif; font-size:14px; font-weight:700; color:var(--t1); display:block; }
.sb-brand-sub { font-size:11px; color:var(--t3); margin-top:2px; display:block; }
.sb-nav { padding:16px 12px; flex:1; }
.nav-item {
  display:flex; align-items:center; gap:10px;
  padding:10px 12px; border-radius:var(--rs); cursor:pointer;
  font-size:14px; color:var(--t2); transition:background .15s, color .15s;
  margin-bottom:2px; user-select:none;
}
.nav-item svg { width:16px; height:16px; flex-shrink:0; }
.nav-item:hover { background:var(--sf2); color:var(--t1); }
.nav-item.active { background:rgba(79,142,247,.15); color:var(--ac); }
.sb-footer { padding:16px 12px; border-top:1px solid var(--bd); }
.btn-logout {
  display:flex; align-items:center; gap:8px; width:100%;
  padding:9px 12px; background:none; border:1px solid var(--bd);
  border-radius:var(--rs); color:var(--t2); font-size:13px;
  font-family:inherit; cursor:pointer; transition:border-color .15s, color .15s;
}
.btn-logout svg { width:14px; height:14px; }
.btn-logout:hover { border-color:var(--red); color:var(--red); }

/* Main */
.main { flex:1; display:flex; flex-direction:column; min-width:0; }
.topbar {
  padding:20px 32px; border-bottom:1px solid var(--bd);
  display:flex; align-items:center; justify-content:space-between; gap:16px;
  background:var(--sf); position:sticky; top:0; z-index:50;
}
.topbar-title { font-size:18px; font-weight:600; color:var(--t1); }
.topbar-actions { display:flex; gap:10px; }

/* Buttons */
.btn {
  display:inline-flex; align-items:center; gap:7px;
  padding:9px 18px; border-radius:var(--rs);
  font-size:14px; font-weight:500; font-family:inherit;
  cursor:pointer; border:none; transition:opacity .15s, transform .15s;
}
.btn:hover { opacity:.85; }
.btn:active { transform:scale(.98); }
.btn svg { width:15px; height:15px; }
.btn-primary { background:var(--ac); color:#fff; }
.btn-ghost { background:var(--sf2); color:var(--t2); border:1px solid var(--bd); }
.btn-danger { background:var(--red-bg); color:var(--red); border:1px solid rgba(255,69,58,.2); }

/* â”€â”€ VIEWS â”€â”€ */
#listView, #editorView, #settingsView { display:none; }
#listView.vactive, #editorView.vactive, #settingsView.vactive { display:block; }

/* List view */
.content-area { padding:28px 32px; flex:1; }
.stats-row { display:flex; gap:16px; margin-bottom:28px; }
.stat-card { flex:1; background:var(--sf); border:1px solid var(--bd); border-radius:var(--r); padding:20px 24px; }
.stat-label { font-size:12px; color:var(--t3); text-transform:uppercase; letter-spacing:.06em; margin-bottom:8px; }
.stat-value { font-size:28px; font-weight:700; color:var(--t1); font-family:'Noto Serif SC',serif; }

.table-wrap { background:var(--sf); border:1px solid var(--bd); border-radius:var(--r); overflow:hidden; }
.table-head {
  display:grid; grid-template-columns:1fr 130px 90px 110px;
  padding:12px 20px; border-bottom:1px solid var(--bd);
  font-size:11px; color:var(--t3); text-transform:uppercase; letter-spacing:.06em;
}
.trow {
  display:grid; grid-template-columns:1fr 130px 90px 110px;
  padding:14px 20px; border-bottom:1px solid var(--bd);
  align-items:center; gap:12px; transition:background .15s;
}
.trow:last-child { border-bottom:none; }
.trow:hover { background:var(--sf2); }
.trow-title { font-size:14px; font-weight:500; color:var(--t1); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.trow-summary { font-size:12px; color:var(--t3); margin-top:3px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.trow-date { font-size:13px; color:var(--t2); }
.tag-pill { display:inline-flex; align-items:center; background:rgba(79,142,247,.12); color:var(--ac); border-radius:980px; padding:2px 9px; font-size:11px; font-weight:500; }
.row-actions { display:flex; gap:6px; justify-content:flex-end; }
.icon-btn {
  width:32px; height:32px; display:flex; align-items:center; justify-content:center;
  border-radius:var(--rs); border:1px solid var(--bd); background:none; color:var(--t2);
  cursor:pointer; transition:background .15s, color .15s;
}
.icon-btn:hover { background:var(--sf2); color:var(--t1); }
.icon-btn.del:hover { background:var(--red-bg); color:var(--red); border-color:rgba(255,69,58,.2); }
.icon-btn svg { width:15px; height:15px; }
.empty-table { text-align:center; padding:60px 20px; color:var(--t3); }
.empty-table svg { width:40px; height:40px; margin:0 auto 12px; display:block; opacity:.3; }

/* Editor view */
.editor-layout {
  display:grid; grid-template-columns:1fr 280px;
  gap:20px; padding:28px 32px; align-items:start;
}
.editor-main { display:flex; flex-direction:column; gap:16px; }
.title-input {
  width:100%; background:var(--sf); border:1px solid var(--bd); border-radius:var(--r);
  padding:20px 24px; font-family:'Noto Serif SC',serif; font-size:22px; font-weight:600;
  color:var(--t1); outline:none; transition:border-color .2s;
  resize:none; min-height:72px; line-height:1.4;
}
.title-input:focus { border-color:var(--ac); }
.title-input::placeholder { color:var(--t3); }

/* Toolbar */
.editor-toolbar {
  background:var(--sf); border:1px solid var(--bd); border-radius:var(--rs);
  padding:8px 12px; display:flex; gap:2px; flex-wrap:wrap; align-items:center;
  position:sticky; top:0; z-index:10;
}
.tb-btn {
  width:32px; height:32px; display:flex; align-items:center; justify-content:center;
  border:none; background:none; color:var(--t2); border-radius:6px;
  cursor:pointer; font-size:13px; font-family:inherit; font-weight:600;
  transition:background .15s, color .15s;
}
.tb-btn:hover { background:var(--sf2); color:var(--t1); }
.tb-btn svg { width:15px; height:15px; }
.tb-sep { width:1px; height:22px; background:var(--bd); margin:0 6px; flex-shrink:0; }

/* Rich editor */
.rich-editor {
  background:var(--sf); border:1px solid var(--bd); border-radius:var(--r);
  min-height:480px; padding:24px; color:var(--t1); font-size:16px; line-height:1.8;
  outline:none; overflow-y:auto; transition:border-color .2s;
}
.rich-editor:focus { border-color:var(--ac); }
.rich-editor:empty::before { content:attr(data-placeholder); color:var(--t3); pointer-events:none; }
.rich-editor h2 { font-family:'Noto Serif SC',serif; font-size:20px; font-weight:600; margin:28px 0 12px; }
.rich-editor h3 { font-family:'Noto Serif SC',serif; font-size:17px; font-weight:600; margin:20px 0 10px; }
.rich-editor p { margin-bottom:14px; }
.rich-editor blockquote { border-left:3px solid var(--ac); padding:10px 18px; margin:20px 0; background:rgba(79,142,247,.06); border-radius:0 6px 6px 0; color:var(--t2); font-style:italic; }
.rich-editor img { max-width:100%; border-radius:8px; margin:16px 0; display:block; border:2px solid transparent; transition:border-color .15s; cursor:pointer; }
.rich-editor img:hover { border-color:var(--ac); }
.rich-editor ul, .rich-editor ol { padding-left:22px; margin-bottom:14px; }
.rich-editor li { margin-bottom:6px; }
.rich-editor a { color:var(--ac); }
.rich-editor video { width:100%; border-radius:8px; margin:16px 0; display:block; }

/* Editor sidebar cards */
.editor-sidebar { display:flex; flex-direction:column; gap:14px; }
.sb-card { background:var(--sf); border:1px solid var(--bd); border-radius:var(--r); padding:18px; }
.sb-card-title { font-size:12px; font-weight:500; text-transform:uppercase; letter-spacing:.07em; color:var(--t3); margin-bottom:14px; }
.fl { font-size:12px; color:var(--t2); margin-bottom:6px; display:block; }
.fi, .fta {
  width:100%; padding:9px 12px; background:var(--sf2); border:1px solid var(--bd);
  border-radius:var(--rs); color:var(--t1); font-size:13px; font-family:inherit;
  outline:none; transition:border-color .2s; margin-bottom:10px;
}
.fi:focus, .fta:focus { border-color:var(--ac); }
.fta { resize:vertical; min-height:80px; line-height:1.6; }

/* Tags */
.tags-wrap {
  display:flex; flex-wrap:wrap; gap:6px; padding:8px;
  background:var(--sf2); border:1px solid var(--bd); border-radius:var(--rs);
  min-height:40px; cursor:text; margin-bottom:10px;
}
.tags-wrap:focus-within { border-color:var(--ac); }
.tag-chip {
  display:inline-flex; align-items:center; gap:4px;
  background:rgba(79,142,247,.15); color:var(--ac);
  border-radius:980px; padding:2px 10px; font-size:12px;
}
.tag-chip button { background:none; border:none; color:inherit; cursor:pointer; font-size:14px; line-height:1; padding:0; opacity:.7; }
.tag-chip button:hover { opacity:1; }
.tag-real-input { border:none; outline:none; background:transparent; color:var(--t1); font-size:12px; font-family:inherit; flex:1; min-width:80px; }

/* Cover */
.cover-prev {
  width:100%; aspect-ratio:2.35/1; border-radius:var(--rs); background:var(--sf2);
  border:1px solid var(--bd); display:flex; align-items:center; justify-content:center;
  overflow:hidden; margin-bottom:10px; cursor:pointer; transition:border-color .15s; position:relative;
}
.cover-prev:hover { border-color:var(--ac); }
.cover-prev img { width:100%; height:100%; object-fit:cover; position:absolute; inset:0; }
.cover-ph { display:flex; flex-direction:column; align-items:center; gap:6px; color:var(--t3); font-size:12px; }
.cover-ph svg { width:24px; height:24px; }

/* Toast */
.toast-wrap { position:fixed; bottom:24px; right:24px; display:flex; flex-direction:column; gap:10px; z-index:9999; }
.toast { padding:12px 20px; border-radius:var(--rs); font-size:14px; font-weight:500; animation:slideUp .3s ease; box-shadow:0 8px 24px rgba(0,0,0,.4); }
@keyframes slideUp { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:none} }
.toast.ok  { background:var(--grn-bg); color:var(--grn); border:1px solid rgba(48,209,88,.2); }
.toast.err { background:var(--red-bg); color:var(--red); border:1px solid rgba(255,69,58,.2); }
.toast.inf { background:rgba(79,142,247,.15); color:var(--ac); border:1px solid rgba(79,142,247,.2); }

/* Modal */
.modal-ov { position:fixed; inset:0; background:rgba(0,0,0,.7); display:flex; align-items:center; justify-content:center; z-index:500; backdrop-filter:blur(4px); }
.modal { background:var(--sf); border:1px solid var(--bd2); border-radius:18px; padding:32px; width:480px; max-width:90vw; box-shadow:0 40px 80px rgba(0,0,0,.5); }
.modal h3 { font-size:17px; font-weight:600; margin-bottom:8px; }
.modal p { font-size:14px; color:var(--t2); margin-bottom:24px; line-height:1.6; }
.modal-acts { display:flex; gap:10px; justify-content:flex-end; }
.modal input { width:100%; padding:10px 14px; background:var(--sf2); border:1px solid var(--bd); border-radius:var(--rs); color:var(--t1); font-size:14px; font-family:inherit; outline:none; margin-bottom:16px; }
.modal input:focus { border-color:var(--ac); }

/* Settings */
#settingsView .settings-wrap { padding:28px 32px; }
.settings-card { background:var(--sf); border:1px solid var(--bd); border-radius:var(--r); padding:28px; max-width:520px; margin-bottom:20px; }
.settings-card h3 { font-size:16px; font-weight:600; margin-bottom:20px; }
.settings-row { margin-bottom:16px; }
.settings-row label { display:block; font-size:12px; color:var(--t2); margin-bottom:6px; text-transform:uppercase; letter-spacing:.05em; }
.settings-input { width:100%; padding:10px 14px; background:var(--sf2); border:1px solid var(--bd); border-radius:var(--rs); color:var(--t1); font-size:14px; font-family:inherit; outline:none; }
.settings-input:focus { border-color:var(--ac); }
.danger-card { border-color:rgba(255,69,58,.3); }
.danger-card h3 { color:var(--red); }

/* Scrollbar */
::-webkit-scrollbar { width:6px; height:6px; }
::-webkit-scrollbar-track { background:transparent; }
::-webkit-scrollbar-thumb { background:var(--bd2); border-radius:3px; }

/* â”€â”€ RESPONSIVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

/* Tablet (768â€“900px) */
@media(max-width:900px) {
  .editor-layout { grid-template-columns:1fr; }
  .editor-sidebar { order:-1; }
  .table-head { grid-template-columns:1fr 90px; }
  .trow { grid-template-columns:1fr 90px; }
  .table-head > *:nth-child(2), .table-head > *:nth-child(3),
  .trow > *:nth-child(2), .trow > *:nth-child(3) { display:none; }
  .topbar { padding:16px 20px; }
  .content-area { padding:20px; }
  .editor-layout { padding:20px; }
}

/* Mobile (<768px): sidebar collapses to top bar */
@media(max-width:767px) {
  /* Sidebar becomes a top strip */
  .layout { flex-direction:column; }
  .sidebar {
    width:100%; height:auto; position:relative;
    flex-direction:row; align-items:center;
    border-right:none; border-bottom:1px solid var(--bd);
    padding:0;
  }
  .sb-brand { padding:12px 16px; border-bottom:none; border-right:1px solid var(--bd); flex-shrink:0; }
  .sb-brand-sub { display:none; }
  .sb-brand-name { font-size:13px; }
  .sb-nav { padding:8px 12px; display:flex; flex-direction:row; gap:4px; flex:1; }
  .nav-item { padding:7px 10px; font-size:13px; margin-bottom:0; }
  .sb-footer { padding:8px 12px; border-top:none; border-left:1px solid var(--bd); }
  .btn-logout { padding:7px 10px; font-size:12px; }
  .btn-logout span { display:none; }

  /* Topbar */
  .topbar { padding:12px 16px; flex-wrap:wrap; gap:8px; position:relative; }
  .topbar-title { font-size:15px; }
  .btn { padding:7px 12px; font-size:13px; }

  /* Content areas */
  .content-area { padding:16px; }
  .stats-row { flex-direction:column; gap:10px; }
  .stat-card { padding:14px 16px; }
  .stat-value { font-size:22px; }

  /* Table */
  .table-head { display:none; }
  .trow {
    display:flex; flex-direction:column; gap:6px;
    padding:12px 14px; align-items:flex-start;
  }
  .row-actions { width:100%; justify-content:flex-start; }

  /* Editor */
  .editor-layout { padding:16px; gap:14px; grid-template-columns:1fr; }
  .title-input { font-size:18px; padding:14px 16px; }
  .rich-editor { min-height:300px; padding:16px; font-size:15px; }
  .editor-toolbar { gap:1px; padding:6px 8px; }
  .tb-btn { width:28px; height:28px; font-size:12px; }

  /* Settings */
  .settings-wrap { padding:16px !important; }
  .settings-card { padding:18px; }

  /* Login card */
  .login-card { width:calc(100vw - 32px); padding:36px 24px; }

  /* Toast bottom center on mobile */
  .toast-wrap { right:16px; left:16px; bottom:16px; }
  .toast { text-align:center; }
}

/* Very small (<400px) */
@media(max-width:400px) {
  .nav-item { font-size:12px; padding:6px 8px; }
  .topbar-actions { width:100%; }
}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginScreen">
  <div class="login-card">
    <div class="login-logo">
      <div class="login-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="11" width="18" height="11" rx="2"/>
          <path d="M7 11V7a5 5 0 0110 0v4"/>
        </svg>
      </div>
      <h1>ç™¾å€æœºä¼šæ”»ç•¥</h1>
      <p>å†…å®¹ç®¡ç†åå°</p>
    </div>
    <div class="fg">
      <label>ç®¡ç†å‘˜å¯†ç </label>
      <input type="password" id="pwdInput" placeholder="è¯·è¾“å…¥å¯†ç " autocomplete="current-password">
    </div>
    <button class="btn-login" onclick="doLogin()">è¿›å…¥åå°</button>
    <div class="login-err" id="loginErr"></div>
  </div>
</div>

<!-- ADMIN APP -->
<div id="adminApp">
  <div class="layout">

    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sb-brand">
        <span class="sb-brand-name">ç™¾å€æœºä¼šæ”»ç•¥</span>
        <span class="sb-brand-sub">å†…å®¹ç®¡ç†åå°</span>
      </div>
      <nav class="sb-nav">
        <div class="nav-item" id="navList" onclick="switchView('list')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01"/></svg>
          æ–‡ç« ç®¡ç†
        </div>
        <div class="nav-item" id="navSettings" onclick="switchView('settings')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
          ç«™ç‚¹è®¾ç½®
        </div>
      </nav>
      <div class="sb-footer">
        <button class="btn-logout" onclick="doLogout()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4M16 17l5-5-5-5M21 12H9"/></svg>
          é€€å‡ºç™»å½•
        </button>
      </div>
    </aside>

    <main class="main">

      <!-- LIST VIEW -->
      <div id="listView">
        <div class="topbar">
          <div class="topbar-title">æ–‡ç« ç®¡ç†</div>
          <div class="topbar-actions">
            <button class="btn btn-primary" onclick="newArticle()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 5v14M5 12h14"/></svg>
              æ–°å»ºæ–‡ç« 
            </button>
          </div>
        </div>
        <div class="content-area">
          <div class="stats-row">
            <div class="stat-card"><div class="stat-label">æ–‡ç« æ€»æ•°</div><div class="stat-value" id="statTotal">0</div></div>
            <div class="stat-card"><div class="stat-label">æœ¬æœˆå‘å¸ƒ</div><div class="stat-value" id="statMonth">0</div></div>
            <div class="stat-card"><div class="stat-label">æœ€è¿‘æ›´æ–°</div><div class="stat-value" id="statLast" style="font-size:15px;padding-top:6px">â€”</div></div>
          </div>
          <div class="table-wrap">
            <div class="table-head">
              <span>æ ‡é¢˜</span><span>æ—¥æœŸ</span><span>æ ‡ç­¾</span><span style="text-align:right">æ“ä½œ</span>
            </div>
            <div id="articleTable"></div>
          </div>
        </div>
      </div>

      <!-- EDITOR VIEW -->
      <div id="editorView">
        <div class="topbar">
          <div class="topbar-title" id="editorTitle">æ–°å»ºæ–‡ç« </div>
          <div class="topbar-actions">
            <button class="btn btn-ghost" onclick="cancelEdit()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M5 12l7-7M5 12l7 7"/></svg>
              è¿”å›
            </button>
            <button class="btn btn-primary" onclick="saveArticle()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
              ä¿å­˜æ–‡ç« 
            </button>
          </div>
        </div>
        <div class="editor-layout">
          <div class="editor-main">
            <textarea class="title-input" id="editTitle" placeholder="æ–‡ç« æ ‡é¢˜â€¦" rows="1" oninput="autoResize(this)"></textarea>
            <div class="editor-toolbar">
              <button class="tb-btn" title="ç²—ä½“" onclick="fmt('bold')"><b>B</b></button>
              <button class="tb-btn" title="æ–œä½“" onclick="fmt('italic')"><i style="font-style:italic">I</i></button>
              <button class="tb-btn" title="ä¸‹åˆ’çº¿" onclick="fmt('underline')"><u>U</u></button>
              <div class="tb-sep"></div>
              <button class="tb-btn" title="H2æ ‡é¢˜" onclick="fmt('h2')">H2</button>
              <button class="tb-btn" title="H3æ ‡é¢˜" onclick="fmt('h3')">H3</button>
              <div class="tb-sep"></div>
              <button class="tb-btn" title="åˆ—è¡¨" onclick="fmt('insertUnorderedList')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="9" y1="6" x2="20" y2="6"/><line x1="9" y1="12" x2="20" y2="12"/><line x1="9" y1="18" x2="20" y2="18"/><circle cx="4" cy="6" r="1" fill="currentColor"/><circle cx="4" cy="12" r="1" fill="currentColor"/><circle cx="4" cy="18" r="1" fill="currentColor"/></svg>
              </button>
              <button class="tb-btn" title="å¼•ç”¨" onclick="fmt('blockquote')">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 21c3 0 7-1 7-8V5c0-1.25-.756-2.017-2-2H4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2 1 0 1 0 1 1v1c0 1-1 2-2 2s-1 .008-1 1.031V20c0 1 0 1 1 1zm12 0c3 0 7-1 7-8V5c0-1.25-.757-2.017-2-2h-4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2h.75c0 2.25.25 4-2.75 4v3c0 1 0 1 1 1z"/></svg>
              </button>
              <div class="tb-sep"></div>
              <button class="tb-btn" title="æ’å…¥é“¾æ¥" onclick="insertLink()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/></svg>
              </button>
              <button class="tb-btn" title="æ’å…¥å›¾ç‰‡" onclick="insertImage()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
              </button>
              <button class="tb-btn" title="æ’å…¥è§†é¢‘" onclick="insertVideo()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2"/></svg>
              </button>
              <div class="tb-sep"></div>
              <button class="tb-btn" title="æ’¤é”€" onclick="document.execCommand('undo')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 7v6h6"/><path d="M21 17a9 9 0 00-9-9 9 9 0 00-6 2.3L3 13"/></svg>
              </button>
            </div>
            <div class="rich-editor" id="richEditor" contenteditable="true" data-placeholder="å¼€å§‹å†™æ–‡ç« å†…å®¹â€¦æ”¯æŒå›¾ç‰‡ã€è§†é¢‘ã€å¼•ç”¨ç­‰å¯Œæ–‡æœ¬æ ¼å¼"></div>
          </div>
          <div class="editor-sidebar">
            <div class="sb-card">
              <div class="sb-card-title">æ–‡ç« ä¿¡æ¯</div>
              <label class="fl">å‘å¸ƒæ—¥æœŸ</label>
              <input type="date" class="fi" id="editDate">
              <label class="fl">ç®€ä»‹ï¼ˆæ˜¾ç¤ºåœ¨é¦–é¡µï¼‰</label>
              <textarea class="fta" id="editSummary" placeholder="ç®€è¦æè¿°è¿™ç¯‡æ–‡ç« çš„å†…å®¹â€¦"></textarea>
              <label class="fl">æ ‡ç­¾ï¼ˆå›è½¦ç¡®è®¤ï¼‰</label>
              <div class="tags-wrap" id="tagsWrap" onclick="document.getElementById('tagInput').focus()">
                <input class="tag-real-input" id="tagInput" placeholder="è¾“å…¥æ ‡ç­¾â€¦" onkeydown="handleTagInput(event)">
              </div>
            </div>
            <div class="sb-card">
              <div class="sb-card-title">å°é¢å›¾ç‰‡ï¼ˆ2.35:1ï¼‰</div>
              <div class="cover-prev" id="coverPrev" onclick="document.getElementById('coverFileInput').click()">
                <div class="cover-ph" id="coverPh">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
                  <span>ç‚¹å‡»ä¸Šä¼ å°é¢å›¾ç‰‡</span>
                </div>
                <div id="coverUploading" style="display:none;position:absolute;inset:0;background:rgba(0,0,0,0.45);align-items:center;justify-content:center;color:#fff;font-size:13px;">ä¸Šä¼ ä¸­â€¦</div>
              </div>
              <input type="file" id="coverFileInput" accept="image/*" style="display:none" onchange="uploadCoverFile(this)">
              <input type="hidden" id="editCover">
              <div style="display:flex;gap:8px;margin-top:6px;align-items:center;">
                <span id="coverFileName" style="font-size:11px;color:var(--t3);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">æœªé€‰æ‹©å›¾ç‰‡</span>
                <button class="btn btn-ghost" onclick="clearCover()" style="font-size:11px;padding:4px 10px;">æ¸…é™¤</button>
              </div>
            </div>
            <div class="sb-card">
              <div class="sb-card-title">ä½¿ç”¨è¯´æ˜</div>
              <p style="font-size:12px;color:var(--t3);line-height:1.8;">
                å›¾ç‰‡ï¼šå·¥å…·æ  â†’ å›¾ç‰‡å›¾æ ‡<br>
                Bç«™è§†é¢‘ï¼šå·¥å…·æ  â†’ è§†é¢‘ â†’ è¾“å…¥BVå·<br>
                YouTubeï¼šè¾“å…¥è§†é¢‘ID<br>
                MP4ç›´é“¾ï¼šç²˜è´´å®Œæ•´URL<br>
                æ•°æ®å­˜äºæœ¬åœ°æµè§ˆå™¨
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- SETTINGS VIEW -->
      <div id="settingsView">
        <div class="topbar">
          <div class="topbar-title">ç«™ç‚¹è®¾ç½®</div>
          <div class="topbar-actions">
            <button class="btn btn-primary" onclick="saveSettings()">ä¿å­˜è®¾ç½®</button>
          </div>
        </div>
        <div class="settings-wrap">
          <div class="settings-card">
            <h3>åŸºæœ¬ä¿¡æ¯</h3>
            <div class="settings-row"><label>çœ‰æ ‡é¢˜ï¼ˆå¯¼èˆªæ  & header å·¦ä¸Šå°å­—ï¼‰</label><input type="text" class="settings-input" id="setSiteName" placeholder="ç™¾å€æœºä¼šæ”»ç•¥"></div>
            <div class="settings-row"><label>ä¸»æ ‡é¢˜ï¼ˆheader å¤§æ ‡é¢˜ï¼‰</label><input type="text" class="settings-input" id="setSiteSlogan" placeholder="å‘ç°å€¼å¾—ä½ è®¤çœŸå¯¹å¾…çš„æœºä¼š"></div>
            <div class="settings-row"><label>æ—¥æ›´è®¡æ•°æ–‡æ¡ˆï¼ˆ{n} ä»£è¡¨ç¯‡æ•°ï¼‰</label><input type="text" class="settings-input" id="setSiteCountTpl" placeholder="å·²æŒç»­æ—¥æ›´ {n} å¤©"></div>
            <div class="settings-row"><label>äºŒç»´ç è¯´æ˜æ–‡å­—</label><input type="text" class="settings-input" id="setSiteQrLabel" placeholder="æ‰«ç å…³æ³¨å…¬ä¼—å·"></div>
            <div class="settings-row">
              <label>å…¬ä¼—å·äºŒç»´ç å›¾ç‰‡</label>
              <div style="display:flex;align-items:center;gap:10px;margin-top:4px;">
                <div id="qrPreview" style="width:72px;height:72px;border:1px solid var(--bd);border-radius:6px;overflow:hidden;background:var(--sf2);display:flex;align-items:center;justify-content:center;flex-shrink:0;cursor:pointer;" onclick="document.getElementById('qrFileInput').click()">
                  <span style="font-size:22px;">ğŸ–¼</span>
                </div>
                <div style="flex:1;">
                  <button class="btn btn-ghost" style="width:100%;margin-bottom:6px;" onclick="document.getElementById('qrFileInput').click()">ä¸Šä¼ äºŒç»´ç å›¾ç‰‡</button>
                  <div id="qrFileName" style="font-size:11px;color:var(--t3);">æœªä¸Šä¼ </div>
                </div>
              </div>
              <input type="file" id="qrFileInput" accept="image/*" style="display:none" onchange="uploadQrImage(this)">
              <input type="hidden" id="setQrUrl">
            </div>
          </div>
          <div class="settings-card">
            <h3>ä¿®æ”¹åå°å¯†ç </h3>
            <div class="settings-row"><label>å½“å‰å¯†ç </label><input type="password" class="settings-input" id="setPwdOld" placeholder="å½“å‰å¯†ç "></div>
            <div class="settings-row"><label>æ–°å¯†ç </label><input type="password" class="settings-input" id="setPwdNew" placeholder="æ–°å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰"></div>
            <div class="settings-row"><label>ç¡®è®¤æ–°å¯†ç </label><input type="password" class="settings-input" id="setPwdConfirm" placeholder="å†æ¬¡è¾“å…¥æ–°å¯†ç "></div>
            <button class="btn btn-ghost" onclick="changePassword()" style="margin-top:4px">æ›´æ–°å¯†ç </button>
          </div>
          <div class="settings-card">
            <h3>é¡µè„šæ–‡å­—</h3>
            <div class="settings-row"><label>é¡µè„šç‰ˆæƒæ–‡å­—</label><input type="text" class="settings-input" id="setSiteFooter" placeholder="Â© 2024 ç™¾å€æœºä¼šæ”»ç•¥ Â· æ¯å¤©ä¸€ç¯‡ï¼ŒæŒç»­æ›´æ–°"></div>
          </div>
          <div class="settings-card danger-card">
            <h3>æ•°æ®å¤‡ä»½</h3>
            <p style="font-size:13px;color:var(--t2);margin-bottom:16px;line-height:1.6">å¯¼å‡ºæ‰€æœ‰æ–‡ç« æ•°æ®ä¸º JSON æ–‡ä»¶ï¼Œå¯ç”¨äºå¤‡ä»½æˆ–è¿ç§»ã€‚</p>
            <button class="btn btn-ghost" onclick="exportData()" style="margin-right:10px">å¯¼å‡º JSON</button>
            <button class="btn btn-danger" onclick="confirmImport()">å¯¼å…¥ JSON</button>
            <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">
          </div>
        </div>
      </div>

    </main>
  </div>
</div>

<div class="toast-wrap" id="toastWrap"></div>

<script>
var AUTH_KEY    = 'baibei_admin_auth';
var DEFAULT_PWD = 'czf330881812';
var SUPABASE_URL = 'https://pmazexeasryqogyfjhbi.supabase.co';
var SUPABASE_KEY = 'sb_publishable_JJVVoK8dMkmjAIaklWx4dA_FOTP_7hV';

function sbFetch(path, opts) {
  return fetch(SUPABASE_URL + '/rest/v1/' + path, Object.assign({
    headers: {
      'apikey': SUPABASE_KEY,
      'Authorization': 'Bearer ' + SUPABASE_KEY,
      'Content-Type': 'application/json',
      'Prefer': 'return=representation'
    }
  }, opts || {}));
}

var editingId = null;
var articles  = [];
var tags      = [];
var settings  = {};

/* â”€â”€ AUTH â”€â”€ */
document.getElementById('pwdInput').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') doLogin();
});

function enterAdmin() {
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('adminApp').style.display = 'block';
  sessionStorage.setItem('baibei_authed', '1');
  adminInit();
}

function doLogin() {
  var val = document.getElementById('pwdInput').value;
  sbFetch('settings?key=eq.adminPwd&select=value')
    .then(function(r) { return r.json(); })
    .then(function(rows) {
      var cloudPwd = (rows && rows[0]) ? rows[0].value : null;
      var stored = cloudPwd || localStorage.getItem(AUTH_KEY) || DEFAULT_PWD;
      if (cloudPwd) localStorage.setItem(AUTH_KEY, cloudPwd);
      if (val === stored) {
        enterAdmin();
      } else {
        document.getElementById('loginErr').textContent = 'å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•';
        document.getElementById('pwdInput').value = '';
        document.getElementById('pwdInput').focus();
        setTimeout(function(){ document.getElementById('loginErr').textContent = ''; }, 2500);
      }
    })
    .catch(function() {
      var stored = localStorage.getItem(AUTH_KEY) || DEFAULT_PWD;
      if (val === stored) {
        enterAdmin();
      } else {
        document.getElementById('loginErr').textContent = 'å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•';
        document.getElementById('pwdInput').value = '';
        document.getElementById('pwdInput').focus();
        setTimeout(function(){ document.getElementById('loginErr').textContent = ''; }, 2500);
      }
    });
}

function doLogout() {
  sessionStorage.removeItem('baibei_authed');
  location.reload();
}

// åˆ·æ–°å…ç™»å½•ï¼šsession å†…å·²ç™»å½•åˆ™ç›´æ¥è¿›å…¥
(function(){
  if (sessionStorage.getItem('baibei_authed') === '1') {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('adminApp').style.display = 'block';
    // adminInit ä¼šåœ¨ DOMContentLoaded åç”±æ­£å¸¸æµç¨‹è°ƒç”¨ï¼Œè¿™é‡Œç›´æ¥è°ƒç”¨
    window.addEventListener('DOMContentLoaded', function(){ adminInit(); });
  }
})();

/* â”€â”€ INIT â”€â”€ */
function adminInit() {
  showLoadingState();
  Promise.all([
    sbFetch('articles?select=*&order=date.desc,id.desc').then(function(r){ return r.json(); }),
    sbFetch('settings?select=*').then(function(r){ return r.json(); })
  ]).then(function(results) {
    var arts = results[0];
    var sets = results[1];
    articles = Array.isArray(arts) ? arts : [];
    settings = {};
    if (Array.isArray(sets)) {
      sets.forEach(function(row){ settings[row.key] = row.value; });
    }
    switchView('list');
    fillSettings();
  }).catch(function(e) {
    toast('åŠ è½½æ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ','err');
  });
}

function showLoadingState() {
  var el = document.getElementById('articleTable');
  if (el) el.innerHTML = '<div class="empty-table"><p>æ­£åœ¨åŠ è½½â€¦</p></div>';
  switchView('list');
}

/* Supabase æ›¿ä»£ localStorage â€” å¼‚æ­¥æ“ä½œç”±å„è°ƒç”¨æ–¹å¤„ç† */

/* â”€â”€ VIEWS â”€â”€ */
function switchView(v) {
  var views = ['list','editor','settings'];
  for (var i = 0; i < views.length; i++) {
    var vEl = document.getElementById(views[i]+'View');
    if (vEl) vEl.classList.remove('vactive');
    var ni = document.getElementById('nav' + views[i].charAt(0).toUpperCase() + views[i].slice(1));
    if (ni) ni.classList.remove('active');
  }
  var target = document.getElementById(v+'View');
  if (target) target.classList.add('vactive');
  var active = document.getElementById('nav' + v.charAt(0).toUpperCase() + v.slice(1));
  if (active) active.classList.add('active');
  if (v === 'list') renderList();
}

/* â”€â”€ LIST â”€â”€ */
function renderList() {
  var sorted = articles.slice().sort(function(a,b){ return new Date(b.date)-new Date(a.date); });
  document.getElementById('statTotal').textContent = articles.length;
  var now = new Date(); now.setDate(1); now.setHours(0,0,0,0);
  document.getElementById('statMonth').textContent = articles.filter(function(a){ return new Date(a.date) >= now; }).length;
  document.getElementById('statLast').textContent = sorted.length ? fmtDate(sorted[0].date) : 'â€”';

  var el = document.getElementById('articleTable');
  if (!sorted.length) {
    el.innerHTML = '<div class="empty-table"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg><p>è¿˜æ²¡æœ‰æ–‡ç« ï¼Œç‚¹å‡»"æ–°å»ºæ–‡ç« "å¼€å§‹åˆ›ä½œ</p></div>';
    return;
  }
  el.innerHTML = sorted.map(function(a) {
    var tagHtml = (a.tags||[]).slice(0,2).map(function(t){ return '<span class="tag-pill">'+esc(t)+'</span>'; }).join(' ');
    return '<div class="trow">' +
      '<div><div class="trow-title">'+esc(a.title||'ï¼ˆæ— æ ‡é¢˜ï¼‰')+'</div><div class="trow-summary">'+esc(a.summary||'')+'</div></div>' +
      '<div class="trow-date">'+fmtDate(a.date)+'</div>' +
      '<div>'+tagHtml+'</div>' +
      '<div class="row-actions">' +
        '<button class="icon-btn" title="ç¼–è¾‘" onclick="editArticle(\''+a.id+'\');event.stopPropagation()">' +
          '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>' +
        '</button>' +
        '<button class="icon-btn del" title="åˆ é™¤" onclick="deleteArticle(\''+a.id+'\');event.stopPropagation()">' +
          '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 01-2 2H8a2 2 0 01-2-2L5 6"/><path d="M10 11v6M14 11v6"/><path d="M9 6V4a1 1 0 011-1h4a1 1 0 011 1v2"/></svg>' +
        '</button>' +
      '</div>' +
    '</div>';
  }).join('');
}

/* â”€â”€ EDITOR â”€â”€ */
function newArticle() {
  editingId = null; tags = [];
  document.getElementById('editorTitle').textContent = 'æ–°å»ºæ–‡ç« ';
  document.getElementById('editTitle').value = '';
  document.getElementById('editDate').value = new Date().toISOString().slice(0,10);
  document.getElementById('editSummary').value = '';
  document.getElementById('editCover').value = '';
  document.getElementById('richEditor').innerHTML = '';
  renderTagChips();
  updateCoverPrev();
  switchView('editor');
}

function editArticle(id) {
  var art = null;
  for (var i = 0; i < articles.length; i++) { if (String(articles[i].id) === String(id)) { art = articles[i]; break; } }
  if (!art) return;
  editingId = id; tags = (art.tags||[]).slice();
  document.getElementById('editorTitle').textContent = 'ç¼–è¾‘æ–‡ç« ';
  document.getElementById('editTitle').value = art.title || '';
  document.getElementById('editDate').value = art.date || new Date().toISOString().slice(0,10);
  document.getElementById('editSummary').value = art.summary || '';
  document.getElementById('editCover').value = art.cover || '';
  document.getElementById('richEditor').innerHTML = art.content || '';
  renderTagChips();
  updateCoverPrev();
  switchView('editor');
}

function cancelEdit() { switchView('list'); }

function saveArticle() {
  var title   = document.getElementById('editTitle').value.trim();
  var date    = document.getElementById('editDate').value;
  var summary = document.getElementById('editSummary').value.trim();
  var cover   = document.getElementById('editCover').value.trim();
  var body    = document.getElementById('richEditor').innerHTML;
  if (!title) { toast('è¯·å¡«å†™æ–‡ç« æ ‡é¢˜','err'); return; }
  if (!date)  { toast('è¯·é€‰æ‹©å‘å¸ƒæ—¥æœŸ','err'); return; }

  var payload = { title:title, date:date, summary:summary, cover:cover, tags:tags.slice(), content:body };

  if (editingId !== null) {
    sbFetch('articles?id=eq.' + String(editingId), {
      method: 'PATCH',
      body: JSON.stringify(payload)
    }).then(function(r) {
      if (!r.ok) throw new Error('ä¿å­˜å¤±è´¥');
      return r.json();
    }).then(function(rows) {
      if (rows && rows[0]) {
        for (var i = 0; i < articles.length; i++) {
          if (String(articles[i].id) === String(editingId)) { articles[i] = rows[0]; break; }
        }
      }
      toast('æ–‡ç« å·²æ›´æ–°','ok');
      switchView('list');
    }).catch(function(){ toast('æ›´æ–°å¤±è´¥ï¼Œè¯·é‡è¯•','err'); });
  } else {
    sbFetch('articles', {
      method: 'POST',
      body: JSON.stringify(payload)
    }).then(function(r) {
      if (!r.ok) throw new Error('å‘å¸ƒå¤±è´¥');
      return r.json();
    }).then(function(rows) {
      if (rows && rows[0]) articles.unshift(rows[0]);
      toast('æ–‡ç« å·²å‘å¸ƒ','ok');
      switchView('list');
    }).catch(function(){ toast('å‘å¸ƒå¤±è´¥ï¼Œè¯·é‡è¯•','err'); });
  }
}

function deleteArticle(id) {
  var art = null;
  for (var i = 0; i < articles.length; i++) { if (String(articles[i].id) === String(id)) { art = articles[i]; break; } }
  showModal('ç¡®è®¤åˆ é™¤', 'ç¡®å®šè¦åˆ é™¤ã€Š' + (art ? art.title : 'è¿™ç¯‡æ–‡ç« ') + 'ã€‹å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚', 'åˆ é™¤', 'btn-danger', function() {
    sbFetch('articles?id=eq.' + id, { method: 'DELETE' })
      .then(function(r) {
        if (!r.ok) throw new Error();
        articles = articles.filter(function(a){ return String(a.id) !== String(id); });
        renderList();
        toast('å·²åˆ é™¤','inf');
      }).catch(function(){ toast('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•','err'); });
  });
}

/* â”€â”€ TAGS â”€â”€ */
function handleTagInput(e) {
  if (e.key === 'Enter' || e.key === ',') {
    e.preventDefault();
    var val = e.target.value.trim().replace(/,/g,'');
    if (val && tags.indexOf(val) === -1) { tags.push(val); renderTagChips(); }
    e.target.value = '';
  }
  if (e.key === 'Backspace' && !e.target.value && tags.length) { tags.pop(); renderTagChips(); }
}
function renderTagChips() {
  var wrap = document.getElementById('tagsWrap');
  var inp  = document.getElementById('tagInput');
  wrap.innerHTML = '';
  tags.forEach(function(t, i) {
    var chip = document.createElement('span');
    chip.className = 'tag-chip';
    chip.innerHTML = esc(t) + '<button onclick="removeTag(' + i + ')">Ã—</button>';
    wrap.appendChild(chip);
  });
  wrap.appendChild(inp);
}
function removeTag(i) { tags.splice(i,1); renderTagChips(); }

/* â”€â”€ COVER â”€â”€ */
function updateCoverPrev(url) {
  var prev = document.getElementById('coverPrev');
  var ph   = document.getElementById('coverPh');
  var ex   = prev.querySelector('img');
  if (ex) ex.remove();
  if (url) {
    var img = document.createElement('img'); img.src = url;
    prev.appendChild(img); ph.style.display = 'none';
  } else {
    ph.style.display = '';
  }
}

function uploadQrImage(input) {
  var file = input.files[0];
  if (!file) return;
  if (file.size > 3 * 1024 * 1024) { toast('å›¾ç‰‡ä¸èƒ½è¶…è¿‡ 3MB','err'); return; }
  var ext = file.name.split('.').pop().toLowerCase();
  var fileName = 'qr_' + Date.now() + '.' + ext;
  document.getElementById('qrFileName').textContent = 'ä¸Šä¼ ä¸­â€¦';
  fetch(SUPABASE_URL + '/storage/v1/object/covers/' + fileName, {
    method: 'POST',
    headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY, 'Content-Type': file.type, 'x-upsert': 'true' },
    body: file
  }).then(function(r) {
    if (!r.ok) throw new Error(r.status);
    var url = SUPABASE_URL + '/storage/v1/object/public/covers/' + fileName;
    document.getElementById('setQrUrl').value = url;
    document.getElementById('qrPreview').innerHTML = '<img src="'+url+'" style="width:100%;height:100%;object-fit:cover;">';
    document.getElementById('qrFileName').textContent = file.name;
    toast('äºŒç»´ç ä¸Šä¼ æˆåŠŸ','ok');
  }).catch(function() {
    document.getElementById('qrFileName').textContent = 'ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•';
    toast('ä¸Šä¼ å¤±è´¥','err');
  });
}

function uploadCoverFile(input) {
  var file = input.files[0];
  if (!file) return;
  var maxMB = 5;
  if (file.size > maxMB * 1024 * 1024) { toast('å›¾ç‰‡ä¸èƒ½è¶…è¿‡ 5MB','err'); return; }

  // æ˜¾ç¤ºä¸Šä¼ ä¸­
  var uploading = document.getElementById('coverUploading');
  uploading.style.display = 'flex';

  var ext = file.name.split('.').pop().toLowerCase();
  var fileName = 'cover_' + Date.now() + '.' + ext;

  fetch(SUPABASE_URL + '/storage/v1/object/covers/' + fileName, {
    method: 'POST',
    headers: {
      'apikey': SUPABASE_KEY,
      'Authorization': 'Bearer ' + SUPABASE_KEY,
      'Content-Type': file.type,
      'x-upsert': 'true'
    },
    body: file
  })
  .then(function(r) {
    return r.text().then(function(body) {
      if (!r.ok) {
        uploading.style.display = 'none';
        toast('ä¸Šä¼ å¤±è´¥ï¼š' + r.status + ' ' + body.slice(0,80), 'err');
        console.error('Storage error', r.status, body);
        return;
      }
      var publicUrl = SUPABASE_URL + '/storage/v1/object/public/covers/' + fileName;
      document.getElementById('editCover').value = publicUrl;
      document.getElementById('coverFileName').textContent = file.name;
      updateCoverPrev(publicUrl);
      uploading.style.display = 'none';
      toast('å°é¢ä¸Šä¼ æˆåŠŸ','ok');
    });
  })
  .catch(function(err) {
    uploading.style.display = 'none';
    toast('ä¸Šä¼ å¤±è´¥ï¼š' + (err.message||'ç½‘ç»œé”™è¯¯'), 'err');
    console.error('Upload catch:', err);
  });
}

function clearCover() {
  document.getElementById('editCover').value = '';
  document.getElementById('coverFileName').textContent = 'æœªé€‰æ‹©å›¾ç‰‡';
  document.getElementById('coverFileInput').value = '';
  updateCoverPrev('');
}

/* â”€â”€ TOOLBAR â”€â”€ */
function fmt(cmd) {
  var editor = document.getElementById('richEditor');
  editor.focus();
  if (cmd === 'h2' || cmd === 'h3') { document.execCommand('formatBlock', false, cmd); }
  else if (cmd === 'blockquote')    { document.execCommand('formatBlock', false, 'blockquote'); }
  else                               { document.execCommand(cmd, false, null); }
}
function insertLink() {
  showInputModal('æ’å…¥é“¾æ¥', 'è¯·è¾“å…¥é“¾æ¥ URLï¼š', 'https://', function(url) {
    if (!url) return;
    document.getElementById('richEditor').focus();
    document.execCommand('insertHTML', false, '<a href="' + esc(url) + '" target="_blank">' + esc(url) + '</a>');
  });
}
function insertImage() {
  // å¼¹å‡ºé€‰æ‹©ï¼šä¸Šä¼ å›¾ç‰‡ or è¾“å…¥URL
  var overlay = document.createElement('div');
  overlay.className = 'modal-ov';
  overlay.innerHTML =
    '<div class="modal">' +
    '<h3>æ’å…¥å›¾ç‰‡</h3>' +
    '<div style="display:flex;flex-direction:column;gap:10px;margin-bottom:16px;">' +
      '<button class="btn btn-primary" onclick="triggerBodyImgUpload()" style="width:100%;">ğŸ“ ä»æœ¬åœ°ä¸Šä¼ å›¾ç‰‡</button>' +
      '<div style="text-align:center;font-size:12px;color:var(--t3);">â€” æˆ–è€… â€”</div>' +
      '<input id="bodyImgUrlInput" class="fi" placeholder="ç²˜è´´å›¾ç‰‡ URLâ€¦" style="margin:0">' +
    '</div>' +
    '<div class="modal-acts">' +
      '<button class="btn btn-ghost" onclick="this.closest(\'.modal-ov\').remove()">å–æ¶ˆ</button>' +
      '<button class="btn btn-primary" onclick="insertImageByUrl()">æ’å…¥é“¾æ¥</button>' +
    '</div>' +
    '<input type="file" id="bodyImgFileInput" accept="image/*" style="display:none" onchange="uploadBodyImage(this)">' +
    '</div>';
  document.body.appendChild(overlay);
}

function triggerBodyImgUpload() {
  document.getElementById('bodyImgFileInput').click();
}

function uploadBodyImage(input) {
  var file = input.files[0];
  if (!file) return;
  if (file.size > 5 * 1024 * 1024) { toast('å›¾ç‰‡ä¸èƒ½è¶…è¿‡ 5MB','err'); return; }

  var overlay = input.closest('.modal-ov');
  var btn = overlay.querySelector('.btn-primary');
  btn.textContent = 'ä¸Šä¼ ä¸­â€¦'; btn.disabled = true;

  var ext = file.name.split('.').pop().toLowerCase();
  var fileName = 'body_' + Date.now() + '.' + ext;

  fetch(SUPABASE_URL + '/storage/v1/object/covers/' + fileName, {
    method: 'POST',
    headers: {
      'apikey': SUPABASE_KEY,
      'Authorization': 'Bearer ' + SUPABASE_KEY,
      'Content-Type': file.type,
      'x-upsert': 'true'
    },
    body: file
  })
  .then(function(r) {
    if (!r.ok) throw new Error('failed');
    var url = SUPABASE_URL + '/storage/v1/object/public/covers/' + fileName;
    overlay.remove();
    var editor = document.getElementById('richEditor');
    editor.focus();
    document.execCommand('insertHTML', false,
      '<img src="' + url + '" alt="" style="max-width:100%;border-radius:6px;margin:16px 0;display:block;">');
    toast('å›¾ç‰‡æ’å…¥æˆåŠŸ','ok');
  })
  .catch(function() {
    btn.textContent = 'ğŸ“ ä»æœ¬åœ°ä¸Šä¼ å›¾ç‰‡'; btn.disabled = false;
    toast('ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•','err');
  });
}

function insertImageByUrl() {
  var url = document.getElementById('bodyImgUrlInput').value.trim();
  if (!url) { toast('è¯·è¾“å…¥å›¾ç‰‡ URL','err'); return; }
  var overlay = document.getElementById('bodyImgUrlInput').closest('.modal-ov');
  overlay.remove();
  var editor = document.getElementById('richEditor');
  editor.focus();
  document.execCommand('insertHTML', false,
    '<img src="' + esc(url) + '" alt="" style="max-width:100%;border-radius:6px;margin:16px 0;display:block;">');
}
function insertVideo() {
  var overlay = document.createElement('div');
  overlay.className = 'modal-ov';
  overlay.innerHTML =
    '<div class="modal"><h3>æ’å…¥è§†é¢‘</h3><p>é€‰æ‹©ç±»å‹ï¼Œå¡«å†™ä¿¡æ¯ï¼š</p>' +
    '<select id="vtypeModal" style="width:100%;padding:9px 12px;background:var(--sf2);border:1px solid var(--bd);border-radius:var(--rs);color:var(--t1);font-family:inherit;font-size:13px;outline:none;margin-bottom:14px">' +
      '<option value="bilibili">Bç«™è§†é¢‘ï¼ˆBVå·ï¼‰</option>' +
      '<option value="youtube">YouTubeï¼ˆè§†é¢‘IDï¼‰</option>' +
      '<option value="mp4">ç›´é“¾ MP4 URL</option>' +
    '</select>' +
    '<input id="vvalModal" placeholder="åœ¨è¿™é‡Œè¾“å…¥â€¦">' +
    '<div class="modal-acts">' +
      '<button class="btn btn-ghost" onclick="this.closest(\'.modal-ov\').remove()">å–æ¶ˆ</button>' +
      '<button class="btn btn-primary" onclick="doInsertVideo()">æ’å…¥</button>' +
    '</div></div>';
  document.body.appendChild(overlay);
}
function doInsertVideo() {
  var type = document.getElementById('vtypeModal').value;
  var val  = document.getElementById('vvalModal').value.trim();
  if (!val) return;
  var html = '';
  if (type === 'bilibili') {
    html = '<div style="position:relative;padding-bottom:56.25%;border-radius:8px;overflow:hidden;margin:20px 0;background:#000"><iframe src="https://player.bilibili.com/player.html?bvid=' + val + '&autoplay=0" allowfullscreen loading="lazy" style="position:absolute;top:0;left:0;width:100%;height:100%;border:none"></iframe></div>';
  } else if (type === 'youtube') {
    html = '<div style="position:relative;padding-bottom:56.25%;border-radius:8px;overflow:hidden;margin:20px 0;background:#000"><iframe src="https://www.youtube.com/embed/' + val + '" allowfullscreen loading="lazy" style="position:absolute;top:0;left:0;width:100%;height:100%;border:none"></iframe></div>';
  } else {
    html = '<video controls style="width:100%;border-radius:8px;margin:16px 0;display:block"><source src="' + esc(val) + '"></video>';
  }
  document.getElementById('richEditor').focus();
  document.execCommand('insertHTML', false, html);
  var ov = document.querySelector('.modal-ov');
  if (ov) ov.remove();
}

/* â”€â”€ SETTINGS â”€â”€ */
function fillSettings() {
  document.getElementById('setSiteName').value     = settings.siteName     || 'ç™¾å€æœºä¼šæ”»ç•¥';
  document.getElementById('setSiteSlogan').value   = settings.siteSlogan   || 'å‘ç°å€¼å¾—ä½ è®¤çœŸå¯¹å¾…çš„æœºä¼š';
  document.getElementById('setSiteCountTpl').value = settings.siteCountTpl || 'å·²æŒç»­æ—¥æ›´ {n} å¤©';
  document.getElementById('setSiteQrLabel').value  = settings.siteQrLabel  || 'æ‰«ç å…³æ³¨å…¬ä¼—å·';
  document.getElementById('setSiteFooter').value   = settings.siteFooter   || 'Â© 2024 ç™¾å€æœºä¼šæ”»ç•¥ Â· æ¯å¤©ä¸€ç¯‡ï¼ŒæŒç»­æ›´æ–°';
  document.getElementById('setQrUrl').value        = settings.qrUrl        || '';
  if (settings.qrUrl) {
    document.getElementById('qrPreview').innerHTML = '<img src="'+settings.qrUrl+'" style="width:100%;height:100%;object-fit:cover;">';
    document.getElementById('qrFileName').textContent = 'å·²ä¸Šä¼ ';
  }
}
function saveSettings() {
  settings.siteName     = document.getElementById('setSiteName').value.trim();
  settings.siteSlogan   = document.getElementById('setSiteSlogan').value.trim();
  settings.siteCountTpl = document.getElementById('setSiteCountTpl').value.trim();
  settings.siteQrLabel  = document.getElementById('setSiteQrLabel').value.trim();
  settings.siteFooter   = document.getElementById('setSiteFooter').value.trim();
  settings.qrUrl        = document.getElementById('setQrUrl').value.trim();

  var upserts = Object.keys(settings).map(function(k) {
    return sbFetch('settings?key=eq.' + encodeURIComponent(k), {
      method: 'DELETE'
    }).then(function() {
      return sbFetch('settings', {
        method: 'POST',
        body: JSON.stringify({ key: k, value: settings[k] })
      });
    });
  });

  Promise.all(upserts)
    .then(function(){ toast('è®¾ç½®å·²ä¿å­˜','ok'); })
    .catch(function(){ toast('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•','err'); });
}
function changePassword() {
  var old = document.getElementById('setPwdOld').value;
  var nw  = document.getElementById('setPwdNew').value;
  var cf  = document.getElementById('setPwdConfirm').value;
  if (nw.length < 6)  { toast('æ–°å¯†ç è‡³å°‘ 6 ä½','err'); return; }
  if (nw !== cf)      { toast('ä¸¤æ¬¡å¯†ç ä¸ä¸€è‡´','err'); return; }
  // ä»äº‘ç«¯å–å½“å‰å¯†ç æ¥éªŒè¯ï¼Œç¡®ä¿è·¨è®¾å¤‡ä¸€è‡´
  sbFetch('settings?key=eq.adminPwd&select=value')
    .then(function(r){ return r.json(); })
    .then(function(rows){
      var cur = (rows && rows[0]) ? rows[0].value : DEFAULT_PWD;
      if (old !== cur) { toast('å½“å‰å¯†ç é”™è¯¯','err'); return; }
      // æ›´æ–°äº‘ç«¯å¯†ç 
      sbFetch('settings?key=eq.adminPwd', { method: 'DELETE' }).then(function(){
        return sbFetch('settings', { method: 'POST', body: JSON.stringify({ key: 'adminPwd', value: nw }) });
      }).then(function(){
        localStorage.setItem(AUTH_KEY, nw);
        document.getElementById('setPwdOld').value = '';
        document.getElementById('setPwdNew').value = '';
        document.getElementById('setPwdConfirm').value = '';
        toast('å¯†ç å·²æ›´æ–°ï¼Œæ‰€æœ‰è®¾å¤‡ç«‹å³ç”Ÿæ•ˆ','ok');
      }).catch(function(){ toast('æ›´æ–°å¤±è´¥ï¼Œè¯·é‡è¯•','err'); });
    })
    .catch(function(){ toast('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•','err'); });
}

/* â”€â”€ EXPORT / IMPORT â”€â”€ */
function exportData() {
  var blob = new Blob([JSON.stringify({articles:articles, settings:settings}, null, 2)], {type:'application/json'});
  var url  = URL.createObjectURL(blob);
  var a    = document.createElement('a');
  a.href = url; a.download = 'baibei_backup_' + new Date().toISOString().slice(0,10) + '.json';
  a.click(); URL.revokeObjectURL(url);
  toast('å·²å¯¼å‡ºæ•°æ®æ–‡ä»¶','ok');
}
function confirmImport() {
  showModal('å¯¼å…¥æ•°æ®', 'å¯¼å…¥ä¼šè¦†ç›–ç°æœ‰æ‰€æœ‰æ–‡ç« æ•°æ®ï¼Œè¯·ç¡®ä¿å·²å¤‡ä»½ã€‚', 'é€‰æ‹©æ–‡ä»¶', 'btn-primary', function() {
    document.getElementById('importFile').click();
  });
}
function importData(e) {
  var file = e.target.files[0]; if (!file) return;
  var reader = new FileReader();
  reader.onload = function(ev) {
    try {
      var data = JSON.parse(ev.target.result);
      if (!data.articles) { toast('JSON æ ¼å¼é”™è¯¯','err'); return; }
      // å…ˆæ¸…ç©ºå†æ‰¹é‡æ’å…¥
      sbFetch('articles', { method: 'DELETE', headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY } })
        .then(function() {
          return sbFetch('articles', {
            method: 'POST',
            body: JSON.stringify(data.articles.map(function(a) {
              var r = Object.assign({}, a); delete r.id; return r;
            }))
          });
        }).then(function() {
          articles = data.articles;
          if (data.settings) { settings = data.settings; fillSettings(); }
          renderList(); toast('å¯¼å…¥æˆåŠŸ','ok');
        }).catch(function(){ toast('å¯¼å…¥å¤±è´¥ï¼Œè¯·é‡è¯•','err'); });
    } catch(ex) { toast('JSON æ ¼å¼é”™è¯¯ï¼Œå¯¼å…¥å¤±è´¥','err'); }
  };
  reader.readAsText(file);
  e.target.value = '';
}

/* â”€â”€ MODAL â”€â”€ */
function showModal(title, body, confirmTxt, confirmCls, onConfirm) {
  var el = document.createElement('div');
  el.className = 'modal-ov';
  el.innerHTML = '<div class="modal"><h3>' + esc(title) + '</h3><p>' + esc(body) + '</p>' +
    '<div class="modal-acts">' +
    '<button class="btn btn-ghost" onclick="this.closest(\'.modal-ov\').remove()">å–æ¶ˆ</button>' +
    '<button class="btn ' + confirmCls + '" id="mcBtn">' + esc(confirmTxt) + '</button>' +
    '</div></div>';
  document.body.appendChild(el);
  el.querySelector('#mcBtn').addEventListener('click', function() { el.remove(); onConfirm(); });
}
function showInputModal(title, label, placeholder, onConfirm) {
  var el = document.createElement('div');
  el.className = 'modal-ov';
  el.innerHTML = '<div class="modal"><h3>' + esc(title) + '</h3><p>' + esc(label) + '</p>' +
    '<input id="miInput" placeholder="' + esc(placeholder) + '">' +
    '<div class="modal-acts">' +
    '<button class="btn btn-ghost" onclick="this.closest(\'.modal-ov\').remove()">å–æ¶ˆ</button>' +
    '<button class="btn btn-primary" id="miOk">ç¡®å®š</button>' +
    '</div></div>';
  document.body.appendChild(el);
  var inp = el.querySelector('#miInput'); inp.focus();
  inp.addEventListener('keydown', function(e) { if (e.key === 'Enter') { el.remove(); onConfirm(inp.value.trim()); } });
  el.querySelector('#miOk').addEventListener('click', function() { el.remove(); onConfirm(inp.value.trim()); });
}

/* â”€â”€ TOAST â”€â”€ */
function toast(msg, type) {
  var el = document.createElement('div');
  el.className = 'toast ' + (type || 'inf');
  el.textContent = msg;
  document.getElementById('toastWrap').appendChild(el);
  setTimeout(function() { if (el.parentNode) el.remove(); }, 3000);
}

/* â”€â”€ HELPERS â”€â”€ */
function esc(s) {
  if (typeof s !== 'string') return '';
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function fmtDate(d) {
  if (!d) return 'â€”';
  return new Date(d).toLocaleDateString('zh-CN', {year:'numeric', month:'2-digit', day:'2-digit'});
}
function autoResize(el) { el.style.height = 'auto'; el.style.height = el.scrollHeight + 'px'; }

/* Paste guard */
document.addEventListener('DOMContentLoaded', function() {
  var editor = document.getElementById('richEditor');
  if (editor) {
    editor.addEventListener('paste', function(e) {
      var items = e.clipboardData && e.clipboardData.items;
      if (!items) return;
      for (var i = 0; i < items.length; i++) {
        if (items[i].type.indexOf('image/') === 0) {
          e.preventDefault();
          toast('è¯·å°†å›¾ç‰‡ä¸Šä¼ è‡³å›¾åºŠåç²˜è´´URLï¼Œä¸æ”¯æŒç›´æ¥ç²˜è´´æœ¬åœ°å›¾ç‰‡','inf');
          return;
        }
      }
    });
  }
});
</script>
</body>
</html>
