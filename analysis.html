<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AIæŠ•ç ”åˆ†æ - ç™¾å€æœºä¼šæ”»ç•¥</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;500;600&family=Noto+Sans+SC:wght@300;400;500&display=swap" rel="stylesheet">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
:root {
  --bg: #f5f0e8; --bg2: #ede8de; --text: #2c2c2c; --text-light: #888;
  --text-mid: #555; --border: #d8d0c0; --accent: #8b6f47; --accent-light: #c4a882;
  --green: #4a7c59; --red: #b85450; --card: #faf7f2;
}
body { font-family: 'Noto Sans SC', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }

.nav { border-bottom: 1px solid var(--border); padding: 0 24px; display: flex; align-items: center; gap: 24px; height: 52px; background: var(--bg); position: sticky; top: 0; z-index: 100; }
.nav-brand { font-family: 'Noto Serif SC', serif; font-size: 15px; font-weight: 600; color: var(--text); text-decoration: none; white-space: nowrap; }
.nav-search { flex: 1; max-width: 400px; height: 32px; border: 1px solid var(--border); border-radius: 4px; padding: 0 12px; font-size: 13px; background: var(--bg2); color: var(--text); outline: none; }

.main { max-width: 900px; margin: 0 auto; padding: 40px 16px 80px; }
.page-header { margin-bottom: 32px; padding-bottom: 20px; border-bottom: 2px solid var(--text); }
.page-label { font-size: 12px; color: var(--accent); letter-spacing: 2px; margin-bottom: 8px; }
.page-title { font-family: 'Noto Serif SC', serif; font-size: 26px; font-weight: 600; margin-bottom: 8px; }
.page-desc { font-size: 13px; color: var(--text-light); line-height: 1.8; }
.page-warning { font-size: 12px; color: var(--red); margin-top: 6px; font-weight: 500; }

.input-section { background: var(--card); border: 1px solid var(--border); border-radius: 2px; padding: 24px; margin-bottom: 24px; }
.input-row { display: flex; gap: 10px; align-items: flex-end; flex-wrap: wrap; }
.input-group { display: flex; flex-direction: column; gap: 5px; flex: 1; min-width: 160px; }
.input-label { font-size: 12px; color: var(--text-mid); }
.input-field { height: 40px; border: 1px solid var(--border); border-radius: 2px; padding: 0 12px; font-size: 14px; background: var(--bg); color: var(--text); outline: none; font-family: inherit; transition: border-color 0.2s; }
.input-field:focus { border-color: var(--accent); }
.input-field::placeholder { color: var(--text-light); }
.select-field { height: 40px; border: 1px solid var(--border); border-radius: 2px; padding: 0 12px; font-size: 14px; background: var(--bg); color: var(--text); outline: none; cursor: pointer; font-family: inherit; }
.btn-analyze { height: 40px; padding: 0 24px; background: var(--text); color: var(--bg); border: none; border-radius: 2px; font-size: 14px; font-family: 'Noto Sans SC', sans-serif; cursor: pointer; white-space: nowrap; transition: background 0.2s; letter-spacing: 1px; }
.btn-analyze:hover { background: var(--accent); }
.btn-analyze:disabled { background: var(--border); cursor: not-allowed; }
.hint { margin-top: 12px; font-size: 12px; color: var(--text-light); }
.hint span { color: var(--accent); }

/* è¿›åº¦ */
.progress-section { display: none; background: var(--card); border: 1px solid var(--border); border-radius: 2px; padding: 24px; margin-bottom: 24px; }
.progress-section.show { display: block; }
.progress-header { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; }
.spinner { width: 18px; height: 18px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; flex-shrink: 0; }
.spinner-sm { width: 12px; height: 12px; border-width: 1.5px; }
@keyframes spin { to { transform: rotate(360deg); } }
.progress-title { font-family: 'Noto Serif SC', serif; font-size: 15px; font-weight: 500; }
.progress-stats { display: grid; grid-template-columns: repeat(3,1fr); gap: 12px; margin-bottom: 16px; }
.stat-card { background: var(--bg2); border: 1px solid var(--border); border-radius: 2px; padding: 12px; text-align: center; }
.stat-label { font-size: 11px; color: var(--text-light); margin-bottom: 4px; }
.stat-value { font-family: 'Noto Serif SC', serif; font-size: 18px; font-weight: 600; color: var(--accent); }
.progress-bar-wrap { background: var(--bg2); border-radius: 2px; height: 6px; margin-bottom: 14px; overflow: hidden; }
.progress-bar-fill { height: 100%; background: var(--accent); border-radius: 2px; transition: width 0.5s ease; width: 0%; }
.current-step-box { border: 1px solid var(--accent-light); background: #fdf8f2; border-radius: 2px; padding: 12px 16px; font-size: 13px; color: var(--accent); display: flex; align-items: center; gap: 8px; }

.error-bar { display: none; padding: 14px 18px; background: #fdf0f0; border: 1px solid #e8c0c0; border-radius: 2px; font-size: 13px; color: var(--red); margin-bottom: 24px; }
.error-bar.show { display: block; }

/* ç»“æœ */
.result-section { display: none; }
.result-section.show { display: block; }
.result-header { display: flex; align-items: baseline; justify-content: space-between; flex-wrap: wrap; gap: 8px; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 2px solid var(--text); }
.result-stock-name { font-family: 'Noto Serif SC', serif; font-size: 22px; font-weight: 600; }
.result-meta { font-size: 12px; color: var(--text-light); }

.signal-row { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
.signal-tag { display: inline-flex; align-items: center; gap: 5px; padding: 6px 14px; border-radius: 2px; font-size: 13px; font-weight: 500; border: 1px solid; }
.signal-tag.buy { background: #f0f7f2; border-color: var(--green); color: var(--green); }
.signal-tag.sell { background: #fdf0f0; border-color: var(--red); color: var(--red); }
.signal-tag.hold { background: #f7f4ee; border-color: var(--accent-light); color: var(--accent); }
.signal-dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; }
.signal-extra { font-size: 12px; color: var(--text-light); }

.report-warning { background: #fff3f3; border: 1px solid #f5c0c0; border-left: 3px solid var(--red); border-radius: 0 2px 2px 0; padding: 10px 16px; margin-bottom: 20px; font-size: 12px; color: var(--red); font-weight: 500; }

.download-bar { display: flex; justify-content: flex-end; margin-bottom: 20px; }
.btn-download { display: inline-flex; align-items: center; gap: 6px; padding: 10px 22px; background: var(--accent); color: white; border: none; border-radius: 2px; font-size: 13px; font-family: 'Noto Sans SC', sans-serif; cursor: pointer; transition: background 0.2s; letter-spacing: 0.5px; }
.btn-download:hover { background: var(--text); }
.btn-download svg { width: 14px; height: 14px; flex-shrink: 0; }

/* æ ¸å¿ƒç ”åˆ¤ */
.verdict-card { background: var(--card); border: 1px solid var(--border); border-left: 3px solid var(--accent); padding: 22px 26px; margin-bottom: 16px; border-radius: 0 2px 2px 0; }
.verdict-label { font-size: 11px; color: var(--accent); letter-spacing: 3px; margin-bottom: 12px; font-weight: 500; }
.verdict-text { font-size: 14px; line-height: 2.2; color: var(--text-mid); }

/* æŠ•èµ„å»ºè®® */
.invest-card { background: #f0f7f2; border: 1px solid #b8d9c4; border-left: 3px solid var(--green); padding: 20px 26px; margin-bottom: 16px; border-radius: 0 2px 2px 0; }
.invest-label { font-size: 11px; color: var(--green); letter-spacing: 3px; margin-bottom: 10px; font-weight: 500; }
.invest-text { font-size: 14px; line-height: 2.2; color: var(--text-mid); }

.disclaimer { font-size: 11px; color: var(--text-light); line-height: 2; padding: 14px 16px; background: var(--bg2); border-radius: 2px; border: 1px solid var(--border); margin-top: 24px; }
.disclaimer strong { color: var(--red); }

/* é¡µè„š */
.page-footer { text-align: center; padding: 28px 16px; border-top: 1px solid var(--border); margin-top: 48px; font-size: 11px; color: var(--text-light); line-height: 2.2; }
.page-footer strong { color: var(--red); }
.page-footer a { color: var(--accent); }

/* æ’è¡Œæ¦œ */
.ranking-section { margin-top: 40px; padding-top: 24px; border-top: 1px solid var(--border); }
.ranking-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 8px; }
.ranking-item { background: var(--card); border: 1px solid var(--border); border-radius: 2px; padding: 12px 14px; cursor: pointer; transition: background 0.15s, border-color 0.15s; display: flex; flex-direction: column; gap: 4px; }
.ranking-item:hover { background: var(--bg2); border-color: var(--accent-light); }
.ranking-rank { font-size: 10px; color: var(--text-light); }
.ranking-rank.top { color: var(--accent); font-weight: 600; }
.ranking-code { font-family: 'Noto Serif SC', serif; font-size: 15px; font-weight: 600; color: var(--text); }
.ranking-signal { font-size: 11px; font-weight: 500; }
.ranking-signal.buy { color: var(--green); }
.ranking-signal.sell { color: var(--red); }
.ranking-signal.hold { color: var(--accent); }
.ranking-date { font-size: 10px; color: var(--text-light); }
@media (max-width: 640px) {
  .ranking-grid { grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); }
}

/* å†å²è®°å½• */
.history-section { margin-top: 32px; padding-top: 24px; border-top: 1px solid var(--border); }
.history-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; padding-bottom: 10px; border-bottom: 1px solid var(--border); }
.history-title { font-family: 'Noto Serif SC', serif; font-size: 15px; font-weight: 600; }
.history-clear { font-size: 12px; color: var(--text-light); background: none; border: 1px solid var(--border); border-radius: 2px; padding: 4px 10px; cursor: pointer; font-family: inherit; }
.history-clear:hover { color: var(--red); border-color: var(--red); }
.history-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 10px; }
.history-item { background: var(--card); border: 1px solid var(--border); border-radius: 2px; padding: 14px 16px; cursor: pointer; transition: background 0.15s, border-color 0.15s; }
.history-item:hover { background: var(--bg2); border-color: var(--accent-light); }
.history-item-code { font-family: 'Noto Serif SC', serif; font-size: 16px; font-weight: 600; color: var(--text); margin-bottom: 4px; }
.history-item-signal { font-size: 11px; font-weight: 500; margin-bottom: 6px; }
.history-item-signal.buy { color: var(--green); }
.history-item-signal.sell { color: var(--red); }
.history-item-signal.hold { color: var(--accent); }
.history-item-date { font-size: 11px; color: var(--text-light); margin-bottom: 10px; }
.history-item-btns { display: flex; gap: 6px; }
.history-btn { flex: 1; font-size: 11px; padding: 5px 0; border-radius: 2px; cursor: pointer; font-family: inherit; text-align: center; transition: background 0.15s; }
.history-btn-view { background: var(--bg2); border: 1px solid var(--border); color: var(--text-mid); }
.history-btn-view:hover { background: var(--bg3); }
.history-btn-pdf { background: var(--accent); border: 1px solid var(--accent); color: white; }
.history-btn-pdf:hover { background: var(--text); border-color: var(--text); }

@media (max-width: 640px) {
  .ranking-grid { grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); }
  .history-grid { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 8px; }
}

/* PDFæ‰“å°æ ·å¼ */
@media print {
  @page { margin: 15mm 18mm; size: A4; }
  * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
  .nav, .input-section, .progress-section, .error-bar, .download-bar, .page-footer, .report-warning { display: none !important; }
  body { background: white !important; font-size: 12px; color: #2c2c2c; }
  .main { padding: 0 !important; max-width: 100% !important; }
  .page-header { border-bottom: 2px solid #2c2c2c; margin-bottom: 20px; padding-bottom: 14px; }
  .page-label { color: #8b6f47 !important; }
  .page-title { font-size: 20px; }
  .page-warning { color: #b85450 !important; }
  .result-section { display: block !important; }
  .result-header { border-bottom: 1px solid #d8d0c0; margin-bottom: 12px; }
  .result-stock-name { font-size: 16px; }
  .verdict-card { border-left: 3px solid #8b6f47 !important; background: #faf7f2 !important; page-break-inside: avoid; margin-bottom: 12px; }
  .verdict-label { color: #8b6f47 !important; }
  .section-card { border: 1px solid #d8d0c0 !important; margin-bottom: 8px; page-break-inside: avoid; }
  .section-hd { background: #f5f0e8 !important; border-bottom: 1px solid #d8d0c0 !important; }
  .section-hd.open { border-bottom: 1px solid #d8d0c0 !important; }
  .section-bd { display: block !important; padding: 12px 16px !important; }
  .section-arrow { display: none; }
  .invest-card { background: #f0f7f2 !important; border-left: 3px solid #4a7c59 !important; page-break-inside: avoid; }
  .invest-label { color: #4a7c59 !important; }
  .disclaimer { display: none !important; }
  .pdf-disclaimer { display: block !important; background: #fff3f3 !important; border: 1px solid #f5c0c0 !important; border-left: 3px solid #b85450 !important; padding: 8px 12px; margin: 10px 0; font-size: 11px; color: #b85450 !important; font-weight: bold; }
  .signal-tag { border: 1px solid currentColor !important; }
  h3, h4 { page-break-after: avoid; }
}
.pdf-disclaimer { display: none; }

@media (max-width: 640px) {
  .nav { padding: 0 14px; gap: 12px; }
  .nav-search { max-width: 150px; font-size: 12px; }
  .main { padding: 24px 12px 60px; }
  .page-title { font-size: 20px; }
  /* ç§»åŠ¨ç«¯å¸ƒå±€ï¼šè‚¡ç¥¨ä»£ç å…¨å®½ï¼Œå¸‚åœº+æ¨¡å¼å¹¶æ’ï¼ŒæŒ‰é’®å…¨å®½ */
  .input-row { flex-wrap: wrap; }
  .input-row .input-group:first-child { width: 100%; flex: none; }
  .input-row .input-group:not(:first-child):not(:last-child) { flex: 1; min-width: 0; max-width: none !important; }
  .btn-analyze { width: 100%; flex: none; }
  .progress-stats { gap: 8px; }
  .stat-value { font-size: 15px; }
  .result-header { flex-direction: column; }
  .download-bar { justify-content: stretch; }
  .btn-download { width: 100%; justify-content: center; }
  .verdict-card { padding: 16px; }
  .section-bd { padding: 16px; }
}
</style>
</head>
<body>
<nav class="nav">
  <a href="/" class="nav-brand">ç™¾å€æœºä¼šæ”»ç•¥</a>
  <input class="nav-search" type="text" placeholder="æœç´¢æ–‡ç« æ ‡é¢˜æˆ–æ­£æ–‡â€¦â€¦">
</nav>

<main class="main">
  <div class="page-header">
    <div class="page-label">ç™¾å€æœºä¼šæ”»ç•¥</div>
    <h1 class="page-title">AI å¤šæ™ºèƒ½ä½“æŠ•ç ”åˆ†æ</h1>
    <p class="page-desc">ç”±å¤šä¸ª AI åˆ†æå¸ˆååŒå®Œæˆï¼Œæ¶µç›–æŠ€æœ¯é¢ã€åŸºæœ¬é¢ã€å¸‚åœºæƒ…ç»ªä¸æ–°é—»èˆ†æƒ…ï¼Œç»¼åˆè¾“å‡ºæŠ•èµ„ç ”åˆ¤ã€‚</p>
    <p class="page-warning">âš ï¸ æ­¤ç³»ç»Ÿä»…ä¾› AI æŠ€æœ¯æ¼”ç¤ºï¼Œä¸æä¾›ä»»ä½•æŠ•èµ„å»ºè®®ï¼Œåˆ‡å‹¿å½“çœŸï¼</p>
  </div>

  <div class="input-section">
    <div class="input-row">
      <div class="input-group">
        <span class="input-label">è‚¡ç¥¨ä»£ç  / åç§°</span>
        <input class="input-field" id="stockInput" type="text" placeholder="å¦‚ 000001 æˆ– AAPL">
      </div>
      <div class="input-group" style="max-width:130px">
        <span class="input-label">å¸‚åœº</span>
        <select class="select-field" id="marketSelect">
          <option value="CN">ğŸ‡¨ğŸ‡³ Aè‚¡</option>
          <option value="HK">ğŸ‡­ğŸ‡° æ¸¯è‚¡</option>
          <option value="US">ğŸ‡ºğŸ‡¸ ç¾è‚¡</option>
        </select>
      </div>
      <div class="input-group" style="max-width:130px">
        <span class="input-label">åˆ†ææ¨¡å¼</span>
        <select class="select-field" id="depthSelect">
          <option value="quick">å¿«é€Ÿåˆ†æ</option>
          <option value="deep" selected>æ·±åº¦åˆ†æ</option>
        </select>
      </div>
      <button class="btn-analyze" id="analyzeBtn" onclick="startAnalysis()">å¼€å§‹åˆ†æ</button>
    </div>
    <div class="hint">æ”¯æŒ Aè‚¡ï¼ˆ6ä½ï¼‰ã€æ¸¯è‚¡ï¼ˆ5ä½ï¼‰ã€ç¾è‚¡ï¼ˆè‹±æ–‡ä»£ç ï¼‰Â· åˆ†æè¿‡ç¨‹çº¦ <span>5-10 åˆ†é’Ÿ</span>ï¼Œè¯·è€å¿ƒç­‰å¾… Â· ä»Šæ—¥å‰©ä½™ <span id="quotaHint" style="color:var(--red);font-weight:600;"></span> æ¬¡å…è´¹åˆ†æ</div>
  </div>

  <div class="progress-section" id="progressSection">
    <div class="progress-header">
      <div class="spinner"></div>
      <div class="progress-title" id="progressTitle">æ­£åœ¨åˆå§‹åŒ–â€¦â€¦</div>
    </div>
    <div class="progress-stats">
      <div class="stat-card"><div class="stat-label">å·²ç”¨æ—¶é—´</div><div class="stat-value" id="statElapsed">0ç§’</div></div>
      <div class="stat-card"><div class="stat-label">é¢„è®¡å‰©ä½™</div><div class="stat-value" id="statRemaining">â€”</div></div>
      <div class="stat-card"><div class="stat-label">é¢„è®¡æ€»æ—¶é•¿</div><div class="stat-value" id="statTotal">â€”</div></div>
    </div>
    <div class="progress-bar-wrap"><div class="progress-bar-fill" id="progressBarFill"></div></div>
    <div class="current-step-box">
      <div class="spinner spinner-sm"></div>
      <span id="currentStepText">æ­£åœ¨å¯åŠ¨â€¦â€¦</span>
    </div>
  </div>

  <div class="error-bar" id="errorBar"></div>

  <div class="result-section" id="resultSection">
    <!-- PDFæ‰“å°æ—¶æ˜¾ç¤ºçš„å…è´£ -->
    <div class="pdf-disclaimer">âš ï¸ æ­¤ç³»ç»Ÿä»…ä¾› AI æŠ€æœ¯æ¼”ç¤ºï¼Œä¸æä¾›ä»»ä½•æŠ•èµ„å»ºè®®ï¼Œåˆ‡å‹¿å½“çœŸï¼æœ¬æŠ¥å‘Šç”± AI è‡ªåŠ¨ç”Ÿæˆï¼Œä¸æ„æˆä»»ä½•æŠ•èµ„å»ºè®®ã€‚</div>

    <div class="result-header">
      <div class="result-stock-name" id="resultStockName"></div>
      <div class="result-meta" id="resultMeta"></div>
    </div>

    <div class="signal-row" id="signalRow"></div>

    <div class="report-warning">âš ï¸ æ­¤ç³»ç»Ÿä»…ä¾› AI æŠ€æœ¯æ¼”ç¤ºï¼Œä¸æä¾›ä»»ä½•æŠ•èµ„å»ºè®®ï¼Œåˆ‡å‹¿å½“çœŸï¼ä»¥ä¸‹å†…å®¹ç”± AI è‡ªåŠ¨ç”Ÿæˆï¼Œä»…ä½œæŠ€æœ¯å±•ç¤ºã€‚</div>

    <div class="verdict-card">
      <div class="verdict-label">æ ¸å¿ƒç ”åˆ¤ï¼ˆæ¼”ç¤ºï¼‰</div>
      <div class="verdict-text" id="verdictText"></div>
    </div>

    <div id="sectionsContainer"></div>

    <div class="invest-card" id="investCard" style="display:none">
      <div class="invest-label">æŠ•èµ„å»ºè®®ï¼ˆæ¼”ç¤ºï¼‰</div>
      <div class="invest-text" id="investText"></div>
      <div style="margin-top:10px;font-size:11px;color:#4a7c59;opacity:0.8;">ä»¥ä¸Šä¸º AI æ¼”ç¤ºæ€§å»ºè®®ï¼Œå®Œæ•´åˆ†æè¯¦è§ PDF æŠ¥å‘Šï¼Œä¸æ„æˆçœŸå®æŠ•èµ„å»ºè®®</div>
    </div>

    <!-- PDFæ‰“å°æ—¶ç»“å°¾å…è´£ -->
    <div class="pdf-disclaimer">âš ï¸ é‡è¦å…è´£å£°æ˜ï¼šæ­¤ç³»ç»Ÿä»…ä¾› AI æŠ€æœ¯æ¼”ç¤ºï¼Œä¸æä¾›ä»»ä½•æŠ•èµ„å»ºè®®ï¼Œåˆ‡å‹¿å½“çœŸï¼è‚¡ç¥¨æŠ•èµ„æœ‰é£é™©ï¼Œå¸‚åœºæƒ…å†µéšæ—¶å˜åŒ–ï¼Œä»»ä½•æŠ•èµ„å†³ç­–è¯·ç»“åˆè‡ªèº«æƒ…å†µï¼Œå¹¶å’¨è¯¢ä¸“ä¸šæŒç‰ŒæŠ•èµ„é¡¾é—®ã€‚</div>

    <div class="disclaimer">
      <strong>âš ï¸ é‡è¦å…è´£å£°æ˜ï¼š</strong>ä»¥ä¸Šå…¨éƒ¨å†…å®¹ç”± AI å¤šæ™ºèƒ½ä½“ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆï¼Œæ­¤ç³»ç»Ÿä»…ä¾› AI æŠ€æœ¯æ¼”ç¤ºï¼Œä¸æä¾›ä»»ä½•æŠ•èµ„å»ºè®®ï¼Œåˆ‡å‹¿å½“çœŸï¼è‚¡ç¥¨æŠ•èµ„æœ‰é£é™©ï¼Œå¸‚åœºæƒ…å†µéšæ—¶å˜åŒ–ï¼Œä»»ä½•æŠ•èµ„å†³ç­–è¯·ç»“åˆè‡ªèº«æƒ…å†µï¼Œå¹¶å’¨è¯¢ä¸“ä¸šæŒç‰ŒæŠ•èµ„é¡¾é—®ã€‚
    </div>
  </div>

  <!-- çƒ­é—¨åˆ†ææ’è¡Œæ¦œ -->
  <div class="ranking-section" id="rankingSection">
    <div class="history-header">
      <div class="history-title">ğŸ”¥ è¿‘æœŸçƒ­é—¨åˆ†æ</div>
      <span style="font-size:11px;color:var(--text-light)">ç‚¹å‡»ç›´æ¥åŠ è½½ç»“æœ</span>
    </div>
    <div id="rankingList"><div class="list-state" style="padding:20px 0"><div class="spinner"></div>åŠ è½½ä¸­â€¦</div></div>
  </div>

  <!-- å†å²åˆ†æè®°å½• -->
  <div class="history-section" id="historySection">
    <div class="history-header">
      <div class="history-title">å†å²åˆ†æè®°å½•</div>
      <button class="history-clear" onclick="clearHistory()">æ¸…ç©º</button>
    </div>
    <div id="historyList"><div style="font-size:13px;color:var(--text-light);padding:16px 0;">æš‚æ— è®°å½•ï¼Œåˆ†æå®Œæˆåè‡ªåŠ¨ä¿å­˜</div></div>
  </div>

</main>

<footer class="page-footer">
  <div>Â© ç™¾å€æœºä¼šæ”»ç•¥ Â· AI å¤šæ™ºèƒ½ä½“æŠ•ç ”æ¼”ç¤ºç³»ç»Ÿ</div>
  <div><strong>âš ï¸ æ­¤ç³»ç»Ÿä»…ä¾› AI æŠ€æœ¯æ¼”ç¤ºï¼Œä¸æä¾›ä»»ä½•æŠ•èµ„å»ºè®®ï¼Œåˆ‡å‹¿å½“çœŸï¼</strong></div>
  <div>å¸‚åœºæœ‰é£é™©ï¼ŒæŠ•èµ„éœ€è°¨æ…ã€‚æœ¬é¡µé¢æ‰€æœ‰åˆ†æå†…å®¹å‡ä¸º AI è‡ªåŠ¨ç”Ÿæˆï¼Œä¸æ„æˆä»»ä½•å½¢å¼çš„æŠ•èµ„å»ºè®®æˆ–æ¨èã€‚</div>
  <div style="margin-top:6px">æœ¬é¡µé¢æ¥æºäº Github å¼€æºé¡¹ç›® TradingAgents-CN</div>
</footer>

<script>
const API_BASE = 'https://api.baibei.xyz';
const ADMIN_USER = 'admin', ADMIN_PASS = 'admin123';
let authToken = null, startTime = null, elapsedTimer = null, currentStockCode = '';

function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

function fmt(s) {
  if (!s || s <= 0) return 'â€”';
  if (s < 60) return Math.round(s) + 'ç§’';
  const m = Math.floor(s/60), sec = Math.round(s%60);
  return sec > 0 ? `${m}åˆ†${sec}ç§’` : `${m}åˆ†é’Ÿ`;
}

function showError(msg) { const b=document.getElementById('errorBar'); b.textContent='âš ï¸ '+msg; b.classList.add('show'); }
function hideError() { document.getElementById('errorBar').classList.remove('show'); }
function showProgress() { document.getElementById('progressSection').classList.add('show'); }
function hideProgress() {
  document.getElementById('progressSection').classList.remove('show');
  if (elapsedTimer) { clearInterval(elapsedTimer); elapsedTimer = null; }
}
function startTimer() {
  startTime = Date.now();
  elapsedTimer = setInterval(() => {
    document.getElementById('statElapsed').textContent = fmt((Date.now()-startTime)/1000);
  }, 1000);
}

const stepMap = {
  pending:'æ­£åœ¨æ’é˜Ÿç­‰å¾…â€¦â€¦', running:'åˆ†æè¿›è¡Œä¸­â€¦â€¦',
  technical:'ğŸ“Š å¸‚åœºæŠ€æœ¯åˆ†æâ€¦â€¦', market:'ğŸ“Š å¸‚åœºæŠ€æœ¯åˆ†æâ€¦â€¦',
  fundamental:'ğŸ“‹ åŸºæœ¬é¢æ·±åº¦åˆ†æâ€¦â€¦', fundamentals:'ğŸ“‹ åŸºæœ¬é¢æ·±åº¦åˆ†æâ€¦â€¦',
  news:'ğŸ“° æ–°é—»èˆ†æƒ…åˆ†æâ€¦â€¦', social_media:'ğŸ’¬ ç¤¾åª’æƒ…ç»ªåˆ†æâ€¦â€¦', social:'ğŸ’¬ ç¤¾åª’æƒ…ç»ªåˆ†æâ€¦â€¦',
  bull:'ğŸ“ˆ å¤šå¤´ç ”ç©¶å‘˜åˆ†æâ€¦â€¦', bear:'ğŸ“‰ ç©ºå¤´ç ”ç©¶å‘˜åˆ†æâ€¦â€¦',
  debate:'âš–ï¸ å¤šç©ºè¾©è®ºä¸­â€¦â€¦', decision:'ğŸ¯ ç ”ç©¶ç»ç†å†³ç­–â€¦â€¦',
  aggressive:'âš¡ æ¿€è¿›åˆ†æå¸ˆè¯„ä¼°â€¦â€¦', conservative:'ğŸ›¡ï¸ ä¿å®ˆåˆ†æå¸ˆè¯„ä¼°â€¦â€¦',
  neutral:'âš–ï¸ ä¸­æ€§åˆ†æå¸ˆè¯„ä¼°â€¦â€¦', portfolio:'ğŸ’¼ æŠ•èµ„ç»„åˆç»ç†å†³ç­–â€¦â€¦',
  finalizing:'âœ… ç»¼åˆç ”åˆ¤ä¸­â€¦â€¦', completed:'âœ… åˆ†æå®Œæˆâ€¦â€¦', failed:'âŒ åˆ†æå¤±è´¥',
};

function updateProgress(status) {
  const elapsed = (Date.now()-startTime)/1000;
  const estimated = status.estimated_duration || 400;
  const remaining = Math.max(0, estimated-elapsed);
  const pct = Math.min(93, status.progress || Math.min(90, elapsed/estimated*100));
  document.getElementById('statElapsed').textContent = fmt(elapsed);
  document.getElementById('statRemaining').textContent = fmt(remaining);
  document.getElementById('statTotal').textContent = fmt(estimated);
  document.getElementById('progressBarFill').style.width = pct+'%';
  const step = status.current_step || status.current_phase || 'running';
  document.getElementById('currentStepText').textContent = stepMap[step] || step+'â€¦â€¦';
}

// ===== API =====
async function apiLogin() {
  const res = await fetch(`${API_BASE}/api/auth/login`, {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({username:ADMIN_USER, password:ADMIN_PASS})
  });
  if (!res.ok) throw new Error('ç™»å½•å¤±è´¥');
  const d = await res.json();
  return d.data?.access_token || d.access_token;
}

async function apiSubmit(stockCode, market, depth) {
  const mMap={CN:'Aè‚¡',HK:'æ¸¯è‚¡',US:'ç¾è‚¡'}, dMap={quick:'å¿«é€Ÿ',deep:'æ·±åº¦'};
  const today = new Date().toISOString().slice(0,10);
  const res = await fetch(`${API_BASE}/api/analysis/single`, {
    method:'POST',
    headers:{'Content-Type':'application/json','Authorization':`Bearer ${authToken}`},
    body: JSON.stringify({
      symbol: stockCode, stock_code: stockCode,
      parameters: {
        market_type: mMap[market]||'Aè‚¡', analysis_date: today,
        research_depth: dMap[depth]||'æ·±åº¦',
        analysts: ['market','fundamentals','news','social_media'],
        llm_provider: 'deepseek',
        quick_thinking_llm: 'deepseek-chat', deep_thinking_llm: 'deepseek-chat'
      }
    })
  });
  if (!res.ok) { const e=await res.json().catch(()=>({})); throw new Error(e.detail||e.message||'æäº¤å¤±è´¥'); }
  const d = await res.json();
  return d.data?.task_id || d.task_id;
}

async function apiStatus(taskId) {
  const res = await fetch(`${API_BASE}/api/analysis/tasks/${taskId}/status`, {headers:{'Authorization':`Bearer ${authToken}`}});
  if (!res.ok) throw new Error('è·å–çŠ¶æ€å¤±è´¥');
  const d = await res.json(); return d.data||d;
}

async function apiResult(taskId) {
  const res = await fetch(`${API_BASE}/api/analysis/tasks/${taskId}/result`, {headers:{'Authorization':`Bearer ${authToken}`}});
  if (!res.ok) throw new Error('è·å–ç»“æœå¤±è´¥');
  const d = await res.json(); return d.data||d;
}

// ===== æ¸²æŸ“ =====
function clsSignal(sig) {
  if (!sig) return 'hold';
  const s = String(sig).toLowerCase();
  if (s.includes('ä¹°')||s.includes('buy')||s.includes('å¢æŒ')) return 'buy';
  if (s.includes('å–')||s.includes('sell')||s.includes('å‡æŒ')) return 'sell';
  return 'hold';
}

function mdToHtml(text) {
  if (!text) return '';
  return text
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
    .replace(/^### (.+)$/gm,'<h3>$1</h3>')
    .replace(/^#### (.+)$/gm,'<h4>$1</h4>')
    .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
    .replace(/^---$/gm,'<hr>')
    .replace(/^\* (.+)$/gm,'<li>$1</li>')
    .replace(/^- (.+)$/gm,'<li>$1</li>')
    .replace(/^(\d+)\. (.+)$/gm,'<li>$2</li>')
    .replace(/(<li>.*<\/li>\n?)+/g, m => `<ul>${m}</ul>`)
    .replace(/\n\n/g,'</p><p>')
    .replace(/\n/g,'<br>');
}

function extractMsgContent(msg) {
  if (!msg) return '';
  if (typeof msg === 'string') return msg;
  return msg.content || '';
}

function buildSections(result) {
  const sections = [];
  const state = result.state || {};
  const debate = state.investment_debate_state || {};
  const msgs = state.messages || [];

  // ä¸»åˆ†ææŠ¥å‘Šï¼ˆstate.messagesçš„ç¬¬ä¸€æ¡ï¼Œé€šå¸¸æ˜¯ç»¼åˆæŠ¥å‘Šï¼‰
  if (msgs.length > 0) {
    const firstMsg = extractMsgContent(msgs[0]);
    if (firstMsg && firstMsg.length > 100) {
      sections.push({icon:'ğŸ“Š', title:'å¸‚åœºæŠ€æœ¯åˆ†ææŠ¥å‘Š', content: firstMsg});
    }
  }

  // reportså­—æ®µ
  const reports = result.reports || {};
  const reportKeys = [
    ['market_analyst',    'ğŸ“Š', 'å¸‚åœºåˆ†æå¸ˆæŠ¥å‘Š'],
    ['fundamentals_analyst','ğŸ“‹','åŸºæœ¬é¢åˆ†æå¸ˆæŠ¥å‘Š'],
    ['news_analyst',      'ğŸ“°', 'æ–°é—»åˆ†æå¸ˆæŠ¥å‘Š'],
    ['social_analyst',    'ğŸ’¬', 'ç¤¾åª’åˆ†æå¸ˆæŠ¥å‘Š'],
    ['bull_analyst',      'ğŸ“ˆ', 'å¤šå¤´ç ”ç©¶å‘˜'],
    ['bear_analyst',      'ğŸ“‰', 'ç©ºå¤´ç ”ç©¶å‘˜'],
  ];
  reportKeys.forEach(([key, icon, title]) => {
    const c = reports[key] || result[key];
    if (c) sections.push({icon, title, content: typeof c==='string'?c:(c.content||c.analysis||'')});
  });

  // investment_debate_state
  if (debate.bull_argument || debate.bear_argument || debate.judge_decision) {
    if (debate.bull_argument) sections.push({icon:'ğŸ“ˆ', title:'å¤šå¤´ç ”ç©¶å‘˜è®ºç‚¹', content: debate.bull_argument});
    if (debate.bear_argument) sections.push({icon:'ğŸ“‰', title:'ç©ºå¤´ç ”ç©¶å‘˜è®ºç‚¹', content: debate.bear_argument});
    if (debate.judge_decision) sections.push({icon:'âš–ï¸', title:'ç ”ç©¶ç»ç†è£å†³', content: debate.judge_decision});
  }

  // risk_debate_state
  const riskDebate = state.risk_debate_state || {};
  if (riskDebate.aggressive_response) sections.push({icon:'âš¡', title:'æ¿€è¿›åˆ†æå¸ˆ', content: riskDebate.aggressive_response});
  if (riskDebate.conservative_response) sections.push({icon:'ğŸ›¡ï¸', title:'ä¿å®ˆåˆ†æå¸ˆ', content: riskDebate.conservative_response});
  if (riskDebate.neutral_response) sections.push({icon:'âš–ï¸', title:'ä¸­æ€§åˆ†æå¸ˆ', content: riskDebate.neutral_response});
  if (riskDebate.judge_decision) sections.push({icon:'ğŸ’¼', title:'æŠ•èµ„ç»„åˆç»ç†', content: riskDebate.judge_decision});

  // key_points å…œåº•
  if (sections.length === 0 && result.key_points?.length > 0) {
    const longPoints = result.key_points.filter(p => p && p.length > 100);
    longPoints.forEach((p, i) => {
      sections.push({icon:'ğŸ“„', title:`åˆ†ææŠ¥å‘Š ${i+1}`, content: p});
    });
  }

  // detailed_analysiså…œåº•
  if (sections.length === 0 && result.detailed_analysis?.reasoning) {
    sections.push({icon:'ğŸ“„', title:'è¯¦ç»†åˆ†æ', content: result.detailed_analysis.reasoning});
  }

  return sections.filter(s => s.content && s.content.trim().length > 20);
}

function toggleSec(i) {
  const bd=document.getElementById('bd'+i), hd=document.getElementById('hd'+i), ar=document.getElementById('ar'+i);
  const open = bd.classList.contains('open');
  bd.classList.toggle('open',!open);
  hd.classList.toggle('open',!open);
  ar.classList.toggle('open',!open);
}

function renderResult(result, stockCode) {
  // ä¿å­˜ç»“æœåˆ°localStorageï¼Œé˜²æ­¢é¡µé¢åˆ·æ–°ä¸¢å¤±
  try {
    localStorage.setItem('last_analysis', JSON.stringify({ result, stockCode, time: Date.now() }));
  } catch(e) {}
  // ä¿å­˜åˆ°å†å²è®°å½•
  saveHistory(result, stockCode);

  document.getElementById('resultSection').classList.add('show');
  const name = result.stock_name || result.stock_symbol || stockCode;
  document.getElementById('resultStockName').textContent = `${name}ï¼ˆ${stockCode}ï¼‰`;
  document.getElementById('resultMeta').textContent = `${new Date().toLocaleDateString('zh-CN')} Â· AIå¤šæ™ºèƒ½ä½“åˆ†æ`;

  // ä¿¡å·
  const da = result.detailed_analysis || {};
  const action = da.action || result.recommendation?.split('ã€‚')[0] || '';
  const confidence = da.confidence ? `ç½®ä¿¡åº¦ ${Math.round(da.confidence*100)}%` : '';
  const risk = result.risk_level ? `é£é™© ${result.risk_level}` : '';
  const sr = document.getElementById('signalRow');
  sr.innerHTML = '';
  if (action) {
    const tag = document.createElement('div');
    tag.className = `signal-tag ${clsSignal(action)}`;
    tag.innerHTML = `<div class="signal-dot"></div>ç»¼åˆä¿¡å·ï¼š${action}`;
    sr.appendChild(tag);
  }
  if (confidence || risk) {
    const ex = document.createElement('span');
    ex.className = 'signal-extra';
    ex.textContent = [confidence, risk].filter(Boolean).join(' Â· ');
    sr.appendChild(ex);
  }

  // ä¸æ˜¾ç¤ºæ ¸å¿ƒç ”åˆ¤å†…å®¹ï¼Œç›´æ¥éšè—verdict-card
  document.getElementById('verdictText').innerHTML = '';
  document.querySelector('.verdict-card').style.display = 'none';

  // éšè—è¯¦ç»†åˆ†æå¸ˆæ¨¡å—
  const container = document.getElementById('sectionsContainer');
  container.innerHTML = '';

  // æŠ•èµ„å»ºè®®ï¼ˆæ¼”ç¤ºï¼‰- ä¿ç•™å®Œæ•´å†…å®¹
  const advice = result.recommendation || result.summary || da.reasoning || '';
  if (advice) {
    document.getElementById('investCard').style.display = 'block';
    document.getElementById('investText').innerHTML = mdToHtml(advice);
  }

  // PDFå¼•å¯¼
  const existingGuide = document.getElementById('pdfGuide');
  if (existingGuide) existingGuide.remove();
  const guide = document.createElement('div');
  guide.id = 'pdfGuide';
  guide.style.cssText = 'margin-top:16px;padding:16px 20px;background:var(--bg2);border:1px solid var(--border);border-radius:2px;';
  guide.innerHTML = `
    <div style="font-size:13px;font-weight:500;color:var(--text);margin-bottom:3px;">ğŸ“„ æŸ¥çœ‹å®Œæ•´æŠ•ç ”æŠ¥å‘Š</div>
    <div style="font-size:12px;color:var(--text-light);margin-bottom:14px;">åŒ…å«æŠ€æœ¯é¢ã€åŸºæœ¬é¢ã€å¤šç©ºè®ºç‚¹ã€é£é™©è¯„ä¼°ç­‰è¯¦ç»†åˆ†æ</div>
    <button id="pdfDownloadBtn" onclick="downloadPDF()" style="width:100%;display:flex;align-items:center;justify-content:center;gap:8px;padding:12px;background:var(--accent);color:white;border:none;border-radius:2px;font-size:14px;cursor:pointer;font-family:inherit;letter-spacing:1px;transition:background 0.2s;">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:15px;height:15px;flex-shrink:0;"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>
      ä¸‹è½½å®Œæ•´ PDF
    </button>`;
  document.getElementById('investCard').after(guide);
}

// ===== PDFä¸‹è½½ï¼šç›´æ¥è°ƒç”¨åç«¯æŠ¥å‘Šæ¥å£ =====
async function downloadPDF() {
  const btn = document.getElementById('pdfDownloadBtn');
  if (!btn) return;
  const orig = btn.innerHTML;
  btn.innerHTML = 'â³ è·å–æŠ¥å‘Šä¸­â€¦â€¦';
  btn.disabled = true;

  try {
    if (!authToken) authToken = await apiLogin();
    const res = await fetch(`${API_BASE}/api/reports/list`, {
      headers: { 'Authorization': `Bearer ${authToken}` }
    });
    const data = await res.json();
    const reports = data.data?.reports || data.reports || [];

    const report = reports.find(r =>
      r.stock_code === currentStockCode && r.status === 'completed'
    ) || reports.find(r => r.status === 'completed');

    if (!report) throw new Error('æœªæ‰¾åˆ°å¯ä¸‹è½½çš„æŠ¥å‘Š');

    const dlRes = await fetch(`${API_BASE}/api/reports/${report.id}/download?format=pdf`, {
      headers: { 'Authorization': `Bearer ${authToken}` }
    });
    if (!dlRes.ok) throw new Error('ä¸‹è½½å¤±è´¥');

    const blob = await dlRes.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `æŠ•ç ”æŠ¥å‘Š_${currentStockCode}_${new Date().toLocaleDateString('zh-CN').replace(/\//g,'-')}.pdf`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    btn.innerHTML = 'âœ… ä¸‹è½½æˆåŠŸ';
    setTimeout(() => { btn.innerHTML = orig; btn.disabled = false; }, 2000);

  } catch(e) {
    showError('ä¸‹è½½å¤±è´¥ï¼š' + e.message);
    btn.innerHTML = orig;
    btn.disabled = false;
  }
}

function updateQuotaHint() {
  const el = document.getElementById('quotaHint');
  if (el) el.textContent = remainingQuota();
}

// ===== æ’è¡Œæ¦œ =====
async function loadRanking() {
  try {
    if (!authToken) authToken = await apiLogin();
    const rRes = await fetch(`${API_BASE}/api/reports/list`, {headers:{'Authorization':`Bearer ${authToken}`}});
    const rData = await rRes.json();
    const reports = (rData.data?.reports || rData.reports || []).filter(r => r.status === 'completed');

    // æŒ‰è‚¡ç¥¨ä»£ç ç»Ÿè®¡å‡ºç°æ¬¡æ•°ï¼Œå–æœ€æ–°çš„ä¸€æ¡è®°å½•
    const map = {};
    reports.forEach(r => {
      if (!map[r.stock_code]) {
        map[r.stock_code] = { count: 0, latest: r };
      }
      map[r.stock_code].count++;
      if (r.analysis_date > map[r.stock_code].latest.analysis_date) {
        map[r.stock_code].latest = r;
      }
    });

    // æŒ‰å‡ºç°æ¬¡æ•°æ’åºï¼Œå–å‰10
    const ranked = Object.values(map)
      .sort((a, b) => b.count - a.count)
      .slice(0, 10);

    if (!ranked.length) {
      document.getElementById('rankingList').innerHTML = '<div style="font-size:13px;color:var(--text-light);padding:16px 0;">æš‚æ— æ•°æ®ï¼Œç­‰å¾…æ›´å¤šç”¨æˆ·åˆ†æåæ˜¾ç¤º</div>';
      return;
    }

    const section = document.getElementById('rankingSection');
    const list = document.getElementById('rankingList');

    const medals = ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];
    list.innerHTML = `<div class="ranking-grid">${ranked.map((item, i) => {
      const r = item.latest;
      // ä»æŠ¥å‘Šsummaryé‡ŒçŒœä¿¡å·
      const sig = r.summary || '';
      let action = 'æŒæœ‰';
      if (sig.includes('ä¹°å…¥') || sig.includes('å¢æŒ')) action = 'ä¹°å…¥';
      else if (sig.includes('å–å‡º') || sig.includes('å‡æŒ')) action = 'å–å‡º';
      const cls = clsSignal(action);
      const rankLabel = medals[i] || `#${i+1}`;
      const daysAgo = Math.floor((Date.now() - new Date(r.analysis_date).getTime()) / (24*60*60*1000));
      const dateLabel = daysAgo === 0 ? 'ä»Šæ—¥' : `${daysAgo}å¤©å‰`;
      return `<div class="ranking-item" onclick="loadRankingItem('${esc2(r.stock_code)}','${esc2(r.task_id)}','${esc2(r.id)}')">
        <div class="ranking-rank ${i<3?'top':''}">${rankLabel} Â· å…±${item.count}æ¬¡</div>
        <div class="ranking-code">${esc2(r.stock_name || r.stock_code)}</div>
        <div class="ranking-signal ${cls}">${action}</div>
        <div class="ranking-date">${dateLabel}åˆ†æ</div>
      </div>`;
    }).join('')}</div>`;
  } catch(e) {
    document.getElementById('rankingList').innerHTML = '<div style="font-size:13px;color:var(--text-light);padding:16px 0;">æš‚æ— æ•°æ®ï¼Œç­‰å¾…æ›´å¤šç”¨æˆ·åˆ†æåæ˜¾ç¤º</div>';
  }
}

async function loadRankingItem(stockCode, taskId, reportId) {
  currentStockCode = stockCode;
  document.getElementById('stockInput').value = stockCode;
  hideError();
  document.getElementById('resultSection').classList.remove('show');
  document.getElementById('analyzeBtn').disabled = true;
  showProgress();
  startTimer();
  document.getElementById('progressTitle').textContent = 'åŠ è½½åˆ†æç»“æœâ€¦â€¦';
  document.getElementById('currentStepText').textContent = 'æ­£åœ¨è¯»å–â€¦â€¦';
  document.getElementById('progressBarFill').style.width = '80%';
  try {
    if (!authToken) authToken = await apiLogin();
    const result = await apiResult(taskId);
    result.report_id = reportId;
    hideProgress();
    const bar = document.createElement('div');
    bar.style.cssText = 'padding:10px 16px;background:#f0f7f2;border:1px solid #b8d9c4;border-left:3px solid var(--green);border-radius:0 2px 2px 0;font-size:12px;color:var(--green);margin-bottom:16px;display:flex;align-items:center;justify-content:space-between;gap:10px;';
    bar.innerHTML = `<span>âš¡ çƒ­é—¨è‚¡ç¥¨ï¼Œç›´æ¥åŠ è½½å·²æœ‰åˆ†æç»“æœï¼ˆèŠ‚çœç®—åŠ›ï¼‰</span><button onclick="this.parentElement.remove()" style="border:none;background:none;cursor:pointer;color:var(--green);font-size:16px;line-height:1;">Ã—</button>`;
    document.querySelector('.input-section').after(bar);
    renderResult(result, stockCode);
    window.scrollTo({ top: document.getElementById('resultSection').offsetTop - 70, behavior: 'smooth' });
  } catch(e) {
    hideProgress();
    showError('åŠ è½½å¤±è´¥ï¼š' + e.message);
  } finally {
    document.getElementById('analyzeBtn').disabled = false;
  }
}

// ===== æ¯æ—¥ä½¿ç”¨é™é¢ =====
const DAILY_LIMIT = 3;
const QUOTA_KEY = 'daily_quota';

function getQuota() {
  try {
    const today = new Date().toISOString().slice(0, 10);
    const raw = localStorage.getItem(QUOTA_KEY);
    if (!raw) return { date: today, count: 0 };
    const q = JSON.parse(raw);
    if (q.date !== today) return { date: today, count: 0 }; // æ–°çš„ä¸€å¤©é‡ç½®
    return q;
  } catch(e) { return { date: new Date().toISOString().slice(0,10), count: 0 }; }
}

function useQuota() {
  const q = getQuota();
  q.count++;
  localStorage.setItem(QUOTA_KEY, JSON.stringify(q));
  updateQuotaHint();
}

function checkQuota() {
  const q = getQuota();
  return q.count < DAILY_LIMIT;
}

function remainingQuota() {
  return Math.max(0, DAILY_LIMIT - getQuota().count);
}

// ===== ä¸»æµç¨‹ =====
async function startAnalysis() {
  const stockCode = document.getElementById('stockInput').value.trim();
  const market = document.getElementById('marketSelect').value;
  const depth = document.getElementById('depthSelect').value;
  if (!stockCode) { showError('è¯·è¾“å…¥è‚¡ç¥¨ä»£ç æˆ–åç§°'); return; }

  // æ£€æŸ¥æ¯æ—¥é™é¢ï¼ˆå‘½ä¸­ç¼“å­˜ä¸æ‰£æ¬¡æ•°ï¼Œåªæœ‰çœŸæ­£æäº¤æ–°ä»»åŠ¡æ‰æ‰£ï¼‰
  // é™é¢æ£€æŸ¥æ”¾åœ¨ç¡®è®¤ä¸æ˜¯ç¼“å­˜ä¹‹åï¼Œè§ä¸‹æ–¹é€»è¾‘
  currentStockCode = stockCode;
  hideError();
  document.getElementById('resultSection').classList.remove('show');
  document.getElementById('analyzeBtn').disabled = true;
  showProgress();
  startTimer();

  try {
    document.getElementById('progressTitle').textContent = 'æ­£åœ¨éªŒè¯èº«ä»½â€¦â€¦';
    document.getElementById('currentStepText').textContent = 'ç™»å½•éªŒè¯ä¸­â€¦â€¦';
    if (!authToken) authToken = await apiLogin();

    document.getElementById('currentStepText').textContent = 'æäº¤åˆ†æä»»åŠ¡ä¸­â€¦â€¦';

    // å…ˆæŸ¥2å¤©å†…æ˜¯å¦å·²æœ‰è¯¥è‚¡ç¥¨çš„åˆ†æç»“æœ
    try {
      if (!authToken) authToken = await apiLogin();
      const rRes = await fetch(`${API_BASE}/api/reports/list`, {headers:{'Authorization':`Bearer ${authToken}`}});
      const rData = await rRes.json();
      const reports = rData.data?.reports || rData.reports || [];
      // å–2å¤©å‰çš„æ—¥æœŸ
      const twoDaysAgo = new Date(Date.now() - 2*24*60*60*1000).toISOString().slice(0, 10);
      const cached = reports.find(r =>
        r.stock_code === stockCode &&
        r.status === 'completed' &&
        r.analysis_date >= twoDaysAgo
      );
      if (cached) {
        document.getElementById('currentStepText').textContent = 'âœ… å‘ç°è¿‘æœŸåˆ†æç»“æœï¼Œç›´æ¥åŠ è½½â€¦â€¦';
        document.getElementById('progressBarFill').style.width = '100%';
        await sleep(600);
        const result = await apiResult(cached.task_id);
        result.report_id = cached.id;
        hideProgress();
        localStorage.removeItem('pending_task');
        const daysAgo = Math.floor((Date.now() - new Date(cached.analysis_date).getTime()) / (24*60*60*1000));
        const timeLabel = daysAgo === 0 ? 'ä»Šæ—¥' : `${daysAgo}å¤©å‰`;
        const bar = document.createElement('div');
        bar.style.cssText = 'padding:10px 16px;background:#f0f7f2;border:1px solid #b8d9c4;border-left:3px solid var(--green);border-radius:0 2px 2px 0;font-size:12px;color:var(--green);margin-bottom:16px;display:flex;align-items:center;justify-content:space-between;gap:10px;';
        bar.innerHTML = `<span>âš¡ å·²æœ‰ä»–äºº${timeLabel}çš„åˆ†æç»“æœï¼Œç›´æ¥åŠ è½½ï¼ˆèŠ‚çœç®—åŠ›ï¼‰</span><button onclick="this.parentElement.remove()" style="border:none;background:none;cursor:pointer;color:var(--green);font-size:16px;line-height:1;">Ã—</button>`;
        document.querySelector('.input-section').after(bar);
        renderResult(result, stockCode);
        document.getElementById('analyzeBtn').disabled = false;
        return;
      }
    } catch(e) {}

    // æ²¡æœ‰ç¼“å­˜ï¼Œæ£€æŸ¥æ¯æ—¥é™é¢
    if (!checkQuota()) {
      hideProgress();
      showError(`ä»Šæ—¥å…è´¹åˆ†ææ¬¡æ•°ï¼ˆ${DAILY_LIMIT}æ¬¡ï¼‰å·²ç”¨å®Œï¼Œæ˜å¤©å†æ¥å§ï½`);
      document.getElementById('analyzeBtn').disabled = false;
      return;
    }
    // æ‰£é™¤æœ¬æ¬¡ä½¿ç”¨æ¬¡æ•°
    useQuota();

    const taskId = await apiSubmit(stockCode, market, depth);
    if (!taskId) throw new Error('æœªè·å–åˆ°ä»»åŠ¡IDï¼Œè¯·é‡è¯•');
    // ä¿å­˜taskIdï¼Œé˜²æ­¢é¡µé¢åˆ·æ–°åä¸¢å¤±
    try { localStorage.setItem('pending_task', JSON.stringify({ taskId, stockCode, market, depth, time: Date.now() })); } catch(e) {}
    document.getElementById('progressTitle').textContent = 'åˆ†æè¿›è¡Œä¸­â€¦â€¦';

    let attempts = 0;
    while (attempts < 200) {
      await sleep(5000);
      const status = await apiStatus(taskId);
      updateProgress(status);
      if (status.status === 'completed' || status.status === 'success') {
        document.getElementById('currentStepText').textContent = 'âœ… åˆ†æå®Œæˆï¼Œæ­£åœ¨åŠ è½½ç»“æœâ€¦â€¦';
        document.getElementById('progressBarFill').style.width = '100%';
        await sleep(600);
        const result = await apiResult(taskId);
        // è·å–report_idç”¨äºå†å²ä¸‹è½½
        try {
          const rRes = await fetch(`${API_BASE}/api/reports/list`, {headers:{'Authorization':`Bearer ${authToken}`}});
          const rData = await rRes.json();
          const reports = rData.data?.reports || rData.reports || [];
          const report = reports.find(r => r.stock_code === stockCode && r.status === 'completed');
          if (report) result.report_id = report.id;
        } catch(e) {}
        hideProgress();
        try { localStorage.removeItem('pending_task'); } catch(e) {}
        renderResult(result, stockCode);
        break;
      }
      if (status.status === 'failed' || status.status === 'error') {
        throw new Error(status.error_message || 'åˆ†æå¤±è´¥ï¼Œè¯·é‡è¯•');
      }
      attempts++;
    }
    if (attempts >= 200) throw new Error('åˆ†æè¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•');
  } catch(err) {
    hideProgress();
    try { localStorage.removeItem('pending_task'); } catch(e) {}
    if (err.message.includes('401')) authToken = null;
    showError(err.message);
  } finally {
    document.getElementById('analyzeBtn').disabled = false;
  }
}

document.getElementById('stockInput').addEventListener('keydown', e => {
  if (e.key === 'Enter') startAnalysis();
});

// ===== å†å²è®°å½• =====
const HISTORY_KEY = 'analysis_history';
const HISTORY_MAX = 20;

function saveHistory(result, stockCode) {
  try {
    const da = result.detailed_analysis || {};
    const action = da.action || result.recommendation?.split('ã€‚')[0] || '';
    const reportId = result.report_id || result.analysis_id || null;
    const stockName = result.stock_name || result.stock_symbol || stockCode;
    let history = loadHistory();
    history = history.filter(h => h.stockCode !== stockCode);
    history.unshift({ stockCode, stockName, action, reportId, time: Date.now() });
    if (history.length > HISTORY_MAX) history = history.slice(0, HISTORY_MAX);
    localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
    try { localStorage.setItem(`analysis_result_${stockCode}`, JSON.stringify({ result, stockCode, time: Date.now() })); } catch(e) {}
    renderHistory();
  } catch(e) {}
}

function loadHistory() {
  try { return JSON.parse(localStorage.getItem(HISTORY_KEY)) || []; } catch(e) { return []; }
}

function clearHistory() {
  if (!confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰å†å²è®°å½•ï¼Ÿ')) return;
  localStorage.removeItem(HISTORY_KEY);
  renderHistory();
}

function renderHistory() {
  const history = loadHistory();
  const list = document.getElementById('historyList');
  if (!history.length) {
    list.innerHTML = '<div style="font-size:13px;color:var(--text-light);padding:16px 0;">æš‚æ— è®°å½•ï¼Œåˆ†æå®Œæˆåè‡ªåŠ¨ä¿å­˜</div>';
    return;
  }
  // è¡¥å…¨æ—§æ•°æ®é‡Œæ²¡æœ‰stockNameçš„æ¡ç›®
  history.forEach(h => {
    if (!h.stockName) {
      try {
        const saved = localStorage.getItem(`analysis_result_${h.stockCode}`);
        if (saved) {
          const { result } = JSON.parse(saved);
          h.stockName = result.stock_name || result.stock_symbol || h.stockCode;
        }
      } catch(e) {}
      if (!h.stockName) h.stockName = h.stockCode;
    }
  });
  list.innerHTML = `<div class="history-grid">${history.map((h, i) => {
    const cls = clsSignal(h.action);
    const label = h.action || 'â€”';
    const date = new Date(h.time).toLocaleDateString('zh-CN', {month:'numeric', day:'numeric'});
    return `<div class="history-item">
      <div class="history-item-code">${esc2(h.stockName || h.stockCode)}</div>
      <div class="history-item-signal ${cls}">${esc2(label)}</div>
      <div class="history-item-date">${date}</div>
      <div class="history-item-btns">
        <button class="history-btn history-btn-view" onclick="restoreHistory(${i})">æŸ¥çœ‹</button>
        <button class="history-btn history-btn-pdf" onclick="downloadHistoryPDF(${i})">PDF</button>
      </div>
    </div>`;
  }).join('')}</div>`;
}

function esc2(s) {
  return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function restoreHistory(idx) {
  const history = loadHistory();
  const h = history[idx];
  if (!h) return;
  try {
    // ä¼˜å…ˆä»è¯¥è‚¡ç¥¨ç‹¬ç«‹ç¼“å­˜ä¸­æ¢å¤
    const key = `analysis_result_${h.stockCode}`;
    const saved = localStorage.getItem(key) || localStorage.getItem('last_analysis');
    if (saved) {
      const { result, stockCode } = JSON.parse(saved);
      if (stockCode === h.stockCode) {
        currentStockCode = stockCode;
        document.getElementById('stockInput').value = stockCode;
        renderResult(result, stockCode);
        window.scrollTo({ top: document.getElementById('resultSection').offsetTop - 70, behavior: 'smooth' });
        return;
      }
    }
  } catch(e) {}
  document.getElementById('stockInput').value = h.stockCode;
  showError(`${h.stockCode} çš„è¯¦ç»†ç»“æœå·²è¿‡æœŸï¼Œè¯·é‡æ–°æäº¤åˆ†æ`);
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

async function downloadHistoryPDF(idx) {
  const history = loadHistory();
  const h = history[idx];
  if (!h) return;
  if (!h.reportId) { showError('è¯¥è®°å½•æ— å¯ä¸‹è½½çš„æŠ¥å‘Šï¼Œè¯·é‡æ–°åˆ†æåä¸‹è½½'); return; }

  const btn = document.querySelectorAll('.history-btn-pdf')[idx];
  if (btn) { btn.textContent = 'â€¦'; btn.disabled = true; }

  try {
    if (!authToken) authToken = await apiLogin();
    const dlRes = await fetch(`${API_BASE}/api/reports/${h.reportId}/download?format=pdf`, {
      headers: { 'Authorization': `Bearer ${authToken}` }
    });
    if (!dlRes.ok) throw new Error('ä¸‹è½½å¤±è´¥');
    const blob = await dlRes.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `æŠ•ç ”æŠ¥å‘Š_${h.stockCode}_${new Date(h.time).toLocaleDateString('zh-CN').replace(/\//g,'-')}.pdf`;
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
    URL.revokeObjectURL(url);
  } catch(e) {
    showError('ä¸‹è½½å¤±è´¥ï¼š' + e.message);
  } finally {
    if (btn) { btn.textContent = 'PDF'; btn.disabled = false; }
  }
}
(function restoreLastResult() {
  // åˆå§‹åŒ–å‰©ä½™æ¬¡æ•°æ˜¾ç¤º
  updateQuotaHint();
  // æ¸²æŸ“å†å²åˆ—è¡¨
  renderHistory();
  // åŠ è½½æ’è¡Œæ¦œ
  loadRanking();

  // æ£€æŸ¥æ˜¯å¦æœ‰æœªå®Œæˆçš„ä»»åŠ¡ï¼ˆé¡µé¢åˆ·æ–°åœºæ™¯ï¼‰
  try {
    const pendingRaw = localStorage.getItem('pending_task');
    if (pendingRaw) {
      const { taskId, stockCode, time } = JSON.parse(pendingRaw);
      // åªæ¢å¤2å°æ—¶å†…çš„ä»»åŠ¡
      if (taskId && stockCode && Date.now() - time < 2 * 60 * 60 * 1000) {
        currentStockCode = stockCode;
        document.getElementById('stockInput').value = stockCode;
        // æ˜¾ç¤ºæ¢å¤æç¤º
        const bar = document.createElement('div');
        bar.style.cssText = 'padding:10px 16px;background:#f7f4ee;border:1px solid var(--border);border-radius:2px;font-size:12px;color:var(--accent);margin-bottom:16px;';
        bar.innerHTML = `â³ æ£€æµ‹åˆ°æ­£åœ¨è¿›è¡Œçš„åˆ†æä»»åŠ¡ï¼ˆ${stockCode}ï¼‰ï¼Œæ­£åœ¨æ¢å¤â€¦â€¦`;
        document.querySelector('.input-section').after(bar);
        // æ¢å¤è½®è¯¢
        document.getElementById('analyzeBtn').disabled = true;
        showProgress();
        startTimer();
        document.getElementById('progressTitle').textContent = 'æ¢å¤åˆ†æä»»åŠ¡â€¦â€¦';
        // å¼‚æ­¥æ¢å¤
        (async () => {
          try {
            if (!authToken) authToken = await apiLogin();
            let attempts = 0;
            while (attempts < 200) {
              await sleep(5000);
              const status = await apiStatus(taskId);
              updateProgress(status);
              if (status.status === 'completed' || status.status === 'success') {
                document.getElementById('currentStepText').textContent = 'âœ… åˆ†æå®Œæˆï¼Œæ­£åœ¨åŠ è½½ç»“æœâ€¦â€¦';
                document.getElementById('progressBarFill').style.width = '100%';
                await sleep(600);
                const result = await apiResult(taskId);
                try {
                  const rRes = await fetch(`${API_BASE}/api/reports/list`, {headers:{'Authorization':`Bearer ${authToken}`}});
                  const rData = await rRes.json();
                  const reports = rData.data?.reports || rData.reports || [];
                  const report = reports.find(r => r.stock_code === stockCode && r.status === 'completed');
                  if (report) result.report_id = report.id;
                } catch(e) {}
                hideProgress();
                localStorage.removeItem('pending_task');
                bar.remove();
                renderResult(result, stockCode);
                break;
              }
              if (status.status === 'failed' || status.status === 'error') {
                throw new Error(status.error_message || 'åˆ†æå¤±è´¥');
              }
              attempts++;
            }
          } catch(err) {
            hideProgress();
            localStorage.removeItem('pending_task');
            bar.remove();
            showError('ä»»åŠ¡æ¢å¤å¤±è´¥ï¼š' + err.message);
          } finally {
            document.getElementById('analyzeBtn').disabled = false;
          }
        })();
        return; // æœ‰pendingä»»åŠ¡å°±ä¸å†æ¢å¤ä¸Šæ¬¡ç»“æœ
      } else {
        localStorage.removeItem('pending_task');
      }
    }
  } catch(e) {}

  // æ¢å¤ä¸Šæ¬¡å·²å®Œæˆçš„ç»“æœ
  try {
    const saved = localStorage.getItem('last_analysis');
    if (!saved) return;
    const { result, stockCode, time } = JSON.parse(saved);
    if (Date.now() - time > 24 * 60 * 60 * 1000) return;
    if (!result || !stockCode) return;
    currentStockCode = stockCode;
    document.getElementById('stockInput').value = stockCode;
    const bar = document.createElement('div');
    bar.style.cssText = 'padding:10px 16px;background:#f7f4ee;border:1px solid var(--border);border-radius:2px;font-size:12px;color:var(--accent);margin-bottom:16px;display:flex;align-items:center;justify-content:space-between;gap:10px;';
    const t = new Date(time).toLocaleString('zh-CN', {month:'numeric',day:'numeric',hour:'2-digit',minute:'2-digit'});
    bar.innerHTML = `<span>ğŸ“‹ å·²æ¢å¤ä¸Šæ¬¡åˆ†æç»“æœï¼ˆ${stockCode} Â· ${t}ï¼‰</span><button onclick="this.parentElement.remove()" style="border:none;background:none;cursor:pointer;color:var(--text-light);font-size:16px;line-height:1;">Ã—</button>`;
    document.querySelector('.input-section').after(bar);
    renderResult(result, stockCode);
  } catch(e) {}
})();
</script>
</body>
</html>
