<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AIæŠ•ç ”åˆ†æ - ç™¾å€æœºä¼šæ”»ç•¥</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;500;600&family=Noto+Sans+SC:wght@300;400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
:root {
  --bg: #f5f0e8; --bg2: #ede8de; --text: #2c2c2c; --text-light: #888;
  --text-mid: #555; --border: #d8d0c0; --accent: #8b6f47; --accent-light: #c4a882;
  --green: #4a7c59; --red: #b85450; --card: #faf7f2;
}
body { font-family: 'Noto Sans SC', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }

.nav { border-bottom: 1px solid var(--border); padding: 0 24px; display: flex; align-items: center; gap: 24px; height: 52px; background: var(--bg); position: sticky; top: 0; z-index: 100; }
.nav-brand { font-family: 'Noto Serif SC', serif; font-size: 15px; font-weight: 600; color: var(--text); text-decoration: none; white-space: nowrap; }
.nav-search { flex: 1; max-width: 400px; height: 32px; border: 1px solid var(--border); border-radius: 4px; padding: 0 12px; font-size: 13px; background: var(--bg2); color: var(--text); outline: none; }

.main { max-width: 900px; margin: 0 auto; padding: 40px 16px 80px; }

.page-header { margin-bottom: 32px; padding-bottom: 20px; border-bottom: 2px solid var(--text); }
.page-label { font-size: 12px; color: var(--accent); letter-spacing: 2px; margin-bottom: 8px; }
.page-title { font-family: 'Noto Serif SC', serif; font-size: 26px; font-weight: 600; margin-bottom: 8px; }
.page-desc { font-size: 13px; color: var(--text-light); line-height: 1.8; }
.page-warning { font-size: 12px; color: var(--red); margin-top: 6px; font-weight: 500; }

.input-section { background: var(--card); border: 1px solid var(--border); border-radius: 2px; padding: 24px; margin-bottom: 24px; }
.input-row { display: flex; gap: 10px; align-items: flex-end; flex-wrap: wrap; }
.input-group { display: flex; flex-direction: column; gap: 5px; flex: 1; min-width: 160px; }
.input-label { font-size: 12px; color: var(--text-mid); }
.input-field { height: 40px; border: 1px solid var(--border); border-radius: 2px; padding: 0 12px; font-size: 14px; background: var(--bg); color: var(--text); outline: none; font-family: inherit; transition: border-color 0.2s; }
.input-field:focus { border-color: var(--accent); }
.input-field::placeholder { color: var(--text-light); }
.select-field { height: 40px; border: 1px solid var(--border); border-radius: 2px; padding: 0 12px; font-size: 14px; background: var(--bg); color: var(--text); outline: none; cursor: pointer; font-family: inherit; }
.btn-analyze { height: 40px; padding: 0 24px; background: var(--text); color: var(--bg); border: none; border-radius: 2px; font-size: 14px; font-family: 'Noto Sans SC', sans-serif; cursor: pointer; white-space: nowrap; transition: background 0.2s; letter-spacing: 1px; }
.btn-analyze:hover { background: var(--accent); }
.btn-analyze:disabled { background: var(--border); cursor: not-allowed; }
.hint { margin-top: 12px; font-size: 12px; color: var(--text-light); }
.hint span { color: var(--accent); }

/* è¿›åº¦æ¡ */
.progress-section { display: none; background: var(--card); border: 1px solid var(--border); border-radius: 2px; padding: 24px; margin-bottom: 24px; }
.progress-section.show { display: block; }
.progress-header { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; }
.spinner { width: 18px; height: 18px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; flex-shrink: 0; }
.spinner-sm { width: 12px; height: 12px; border-width: 1.5px; }
@keyframes spin { to { transform: rotate(360deg); } }
.progress-title { font-family: 'Noto Serif SC', serif; font-size: 15px; font-weight: 500; }
.progress-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 16px; }
.stat-card { background: var(--bg2); border: 1px solid var(--border); border-radius: 2px; padding: 12px; text-align: center; }
.stat-label { font-size: 11px; color: var(--text-light); margin-bottom: 4px; }
.stat-value { font-family: 'Noto Serif SC', serif; font-size: 18px; font-weight: 600; color: var(--accent); }
.progress-bar-wrap { background: var(--bg2); border-radius: 2px; height: 6px; margin-bottom: 14px; overflow: hidden; }
.progress-bar-fill { height: 100%; background: var(--accent); border-radius: 2px; transition: width 0.5s ease; width: 0%; }
.current-step-box { border: 1px solid var(--accent-light); background: #fdf8f2; border-radius: 2px; padding: 12px 16px; font-size: 13px; color: var(--accent); display: flex; align-items: center; gap: 8px; }

.error-bar { display: none; padding: 14px 18px; background: #fdf0f0; border: 1px solid #e8c0c0; border-radius: 2px; font-size: 13px; color: var(--red); margin-bottom: 24px; }
.error-bar.show { display: block; }

.result-section { display: none; }
.result-section.show { display: block; }
.result-header { display: flex; align-items: baseline; justify-content: space-between; flex-wrap: wrap; gap: 8px; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border); }
.result-stock-name { font-family: 'Noto Serif SC', serif; font-size: 20px; font-weight: 600; }
.result-meta { font-size: 12px; color: var(--text-light); }

.signal-row { display: flex; gap: 10px; margin-bottom: 16px; flex-wrap: wrap; }
.signal-tag { display: inline-flex; align-items: center; gap: 5px; padding: 5px 12px; border-radius: 2px; font-size: 13px; font-weight: 500; border: 1px solid; }
.signal-tag.buy { background: #f0f7f2; border-color: var(--green); color: var(--green); }
.signal-tag.sell { background: #fdf0f0; border-color: var(--red); color: var(--red); }
.signal-tag.hold { background: #f7f4ee; border-color: var(--accent-light); color: var(--accent); }
.signal-dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; }

.report-warning { background: #fff3f3; border: 1px solid #f5c0c0; border-left: 3px solid var(--red); border-radius: 0 2px 2px 0; padding: 10px 16px; margin-bottom: 16px; font-size: 12px; color: var(--red); font-weight: 500; }

.download-bar { display: flex; justify-content: flex-end; margin-bottom: 16px; }
.btn-download { display: inline-flex; align-items: center; gap: 6px; padding: 9px 20px; background: var(--accent); color: white; border: none; border-radius: 2px; font-size: 13px; font-family: 'Noto Sans SC', sans-serif; cursor: pointer; transition: background 0.2s; }
.btn-download:hover { background: var(--text); }
.btn-download:disabled { background: var(--border); cursor: not-allowed; }
.btn-download svg { width: 14px; height: 14px; flex-shrink: 0; }

.verdict-card { background: var(--card); border: 1px solid var(--border); border-left: 3px solid var(--accent); padding: 20px 24px; margin-bottom: 16px; border-radius: 0 2px 2px 0; }
.verdict-label { font-size: 11px; color: var(--accent); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 10px; }
.verdict-text { font-size: 14px; line-height: 2; color: var(--text-mid); white-space: pre-wrap; }

.section-card { background: var(--card); border: 1px solid var(--border); border-radius: 2px; margin-bottom: 10px; overflow: hidden; }
.section-hd { display: flex; align-items: center; gap: 8px; padding: 13px 18px; border-bottom: 1px solid transparent; cursor: pointer; user-select: none; transition: background 0.15s; }
.section-hd:hover { background: var(--bg2); }
.section-hd.open { border-bottom-color: var(--border); }
.section-icon { font-size: 15px; }
.section-title { font-family: 'Noto Serif SC', serif; font-size: 14px; font-weight: 500; flex: 1; }
.section-arrow { color: var(--text-light); font-size: 10px; transition: transform 0.2s; }
.section-arrow.open { transform: rotate(180deg); }
.section-bd { display: none; padding: 18px 20px; }
.section-bd.open { display: block; }
.section-content { font-size: 13px; line-height: 1.95; color: var(--text-mid); }
.section-content h3 { font-family: 'Noto Serif SC', serif; color: var(--text); margin: 14px 0 6px; font-size: 14px; font-weight: 600; }
.section-content h4 { font-family: 'Noto Serif SC', serif; color: var(--text); margin: 10px 0 4px; font-size: 13px; font-weight: 500; }
.section-content strong { color: var(--text); font-weight: 600; }
.section-content ul { padding-left: 18px; margin: 6px 0; }
.section-content li { margin-bottom: 3px; }
.section-content br { line-height: 2; }

.invest-card { background: #f0f7f2; border: 1px solid #b8d9c4; border-left: 3px solid var(--green); padding: 18px 22px; margin-bottom: 12px; border-radius: 0 2px 2px 0; }
.invest-label { font-size: 11px; color: var(--green); letter-spacing: 2px; margin-bottom: 8px; }
.invest-text { font-size: 14px; line-height: 2; color: var(--text-mid); white-space: pre-wrap; }

.disclaimer { font-size: 11px; color: var(--text-light); line-height: 1.9; padding: 14px 16px; background: var(--bg2); border-radius: 2px; border: 1px solid var(--border); margin-top: 20px; }
.disclaimer strong { color: var(--red); }

.page-footer { text-align: center; padding: 28px 16px; border-top: 1px solid var(--border); margin-top: 48px; font-size: 11px; color: var(--text-light); line-height: 2.2; }
.page-footer strong { color: var(--red); }

@media (max-width: 640px) {
  .nav { padding: 0 14px; gap: 12px; }
  .nav-search { max-width: 160px; font-size: 12px; }
  .main { padding: 24px 12px 60px; }
  .page-title { font-size: 20px; }
  .input-row { flex-direction: column; }
  .input-group { min-width: auto; width: 100%; }
  .btn-analyze { width: 100%; }
  .progress-stats { gap: 8px; }
  .stat-value { font-size: 15px; }
  .result-header { flex-direction: column; }
  .download-bar { justify-content: stretch; }
  .btn-download { width: 100%; justify-content: center; }
}
</style>
</head>
<body>
<nav class="nav">
  <a href="/" class="nav-brand">ç™¾å€æœºä¼šæ”»ç•¥</a>
  <input class="nav-search" type="text" placeholder="æœç´¢æ–‡ç« æ ‡é¢˜æˆ–æ­£æ–‡â€¦â€¦">
</nav>

<main class="main">
  <div class="page-header">
    <div class="page-label">ç™¾å€æœºä¼šæ”»ç•¥</div>
    <h1 class="page-title">AI å¤šæ™ºèƒ½ä½“æŠ•ç ”åˆ†æ</h1>
    <p class="page-desc">ç”±å¤šä¸ª AI åˆ†æå¸ˆååŒå®Œæˆï¼Œæ¶µç›–æŠ€æœ¯é¢ã€åŸºæœ¬é¢ã€å¸‚åœºæƒ…ç»ªä¸æ–°é—»èˆ†æƒ…ï¼Œç»¼åˆè¾“å‡ºæŠ•èµ„ç ”åˆ¤ã€‚</p>
    <p class="page-warning">âš ï¸ æ­¤ç³»ç»Ÿä»…ä¾› AI æŠ€æœ¯æ¼”ç¤ºï¼Œä¸æä¾›ä»»ä½•æŠ•èµ„å»ºè®®ï¼Œåˆ‡å‹¿å½“çœŸï¼</p>
  </div>

  <div class="input-section">
    <div class="input-row">
      <div class="input-group">
        <span class="input-label">è‚¡ç¥¨ä»£ç  / åç§°</span>
        <input class="input-field" id="stockInput" type="text" placeholder="å¦‚ 000001 æˆ– AAPL">
      </div>
      <div class="input-group" style="max-width:130px">
        <span class="input-label">å¸‚åœº</span>
        <select class="select-field" id="marketSelect">
          <option value="CN">ğŸ‡¨ğŸ‡³ Aè‚¡</option>
          <option value="HK">ğŸ‡­ğŸ‡° æ¸¯è‚¡</option>
          <option value="US">ğŸ‡ºğŸ‡¸ ç¾è‚¡</option>
        </select>
      </div>
      <div class="input-group" style="max-width:130px">
        <span class="input-label">åˆ†ææ¨¡å¼</span>
        <select class="select-field" id="depthSelect">
          <option value="quick">å¿«é€Ÿåˆ†æ</option>
          <option value="deep" selected>æ·±åº¦åˆ†æ</option>
        </select>
      </div>
      <button class="btn-analyze" id="analyzeBtn" onclick="startAnalysis()">å¼€å§‹åˆ†æ</button>
    </div>
    <div class="hint">æ”¯æŒ Aè‚¡ï¼ˆ6ä½ï¼‰ã€æ¸¯è‚¡ï¼ˆ5ä½ï¼‰ã€ç¾è‚¡ï¼ˆè‹±æ–‡ä»£ç ï¼‰Â· åˆ†æè¿‡ç¨‹çº¦ <span>5-10 åˆ†é’Ÿ</span>ï¼Œè¯·è€å¿ƒç­‰å¾…</div>
  </div>

  <div class="progress-section" id="progressSection">
    <div class="progress-header">
      <div class="spinner"></div>
      <div class="progress-title" id="progressTitle">æ­£åœ¨åˆå§‹åŒ–â€¦â€¦</div>
    </div>
    <div class="progress-stats">
      <div class="stat-card"><div class="stat-label">å·²ç”¨æ—¶é—´</div><div class="stat-value" id="statElapsed">0ç§’</div></div>
      <div class="stat-card"><div class="stat-label">é¢„è®¡å‰©ä½™</div><div class="stat-value" id="statRemaining">â€”</div></div>
      <div class="stat-card"><div class="stat-label">é¢„è®¡æ€»æ—¶é•¿</div><div class="stat-value" id="statTotal">â€”</div></div>
    </div>
    <div class="progress-bar-wrap"><div class="progress-bar-fill" id="progressBarFill"></div></div>
    <div class="current-step-box">
      <div class="spinner spinner-sm"></div>
      <span id="currentStepText">æ­£åœ¨å¯åŠ¨â€¦â€¦</span>
    </div>
  </div>

  <div class="error-bar" id="errorBar"></div>

  <div class="result-section" id="resultSection">
    <div class="result-header">
      <div class="result-stock-name" id="resultStockName"></div>
      <div class="result-meta" id="resultMeta"></div>
    </div>
    <div class="signal-row" id="signalRow"></div>
    <div class="report-warning">âš ï¸ æ­¤ç³»ç»Ÿä»…ä¾› AI æŠ€æœ¯æ¼”ç¤ºï¼Œä¸æä¾›ä»»ä½•æŠ•èµ„å»ºè®®ï¼Œåˆ‡å‹¿å½“çœŸï¼ä»¥ä¸‹å†…å®¹ç”± AI è‡ªåŠ¨ç”Ÿæˆï¼Œä»…ä½œæŠ€æœ¯å±•ç¤ºã€‚</div>
    <div class="download-bar">
      <button class="btn-download" id="downloadBtn" onclick="downloadPDF()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>
        ä¸‹è½½æŠ•ç ”æŠ¥å‘Š PDF
      </button>
    </div>
    <div class="verdict-card">
      <div class="verdict-label">æ ¸å¿ƒç ”åˆ¤</div>
      <div class="verdict-text" id="verdictText"></div>
    </div>
    <div id="sectionsContainer"></div>
    <div class="invest-card" id="investCard" style="display:none">
      <div class="invest-label">æŠ•èµ„å»ºè®®</div>
      <div class="invest-text" id="investText"></div>
    </div>
    <div class="disclaimer">
      <strong>âš ï¸ é‡è¦å…è´£å£°æ˜ï¼š</strong>ä»¥ä¸Šå…¨éƒ¨å†…å®¹ç”± AI å¤šæ™ºèƒ½ä½“ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆï¼Œæ­¤ç³»ç»Ÿä»…ä¾› AI æŠ€æœ¯æ¼”ç¤ºï¼Œä¸æä¾›ä»»ä½•æŠ•èµ„å»ºè®®ï¼Œåˆ‡å‹¿å½“çœŸï¼è‚¡ç¥¨æŠ•èµ„æœ‰é£é™©ï¼Œå¸‚åœºæƒ…å†µéšæ—¶å˜åŒ–ï¼Œä»»ä½•æŠ•èµ„å†³ç­–è¯·ç»“åˆè‡ªèº«æƒ…å†µï¼Œå¹¶å’¨è¯¢ä¸“ä¸šæŒç‰ŒæŠ•èµ„é¡¾é—®ã€‚
    </div>
  </div>
</main>

<footer class="page-footer">
  <div>Â© ç™¾å€æœºä¼šæ”»ç•¥ Â· AI å¤šæ™ºèƒ½ä½“æŠ•ç ”æ¼”ç¤ºç³»ç»Ÿ</div>
  <div><strong>âš ï¸ æ­¤ç³»ç»Ÿä»…ä¾› AI æŠ€æœ¯æ¼”ç¤ºï¼Œä¸æä¾›ä»»ä½•æŠ•èµ„å»ºè®®ï¼Œåˆ‡å‹¿å½“çœŸï¼</strong></div>
  <div>å¸‚åœºæœ‰é£é™©ï¼ŒæŠ•èµ„éœ€è°¨æ…ã€‚æœ¬é¡µé¢æ‰€æœ‰åˆ†æå†…å®¹å‡ä¸º AI è‡ªåŠ¨ç”Ÿæˆï¼Œä¸æ„æˆä»»ä½•å½¢å¼çš„æŠ•èµ„å»ºè®®æˆ–æ¨èã€‚</div>
</footer>

<script>
const API_BASE = 'https://api.baibei.xyz';
const ADMIN_USER = 'admin';
const ADMIN_PASS = 'admin123';
let authToken = null, startTime = null, elapsedTimer = null, currentResult = null, currentStockCode = '';

function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

function fmt(s) {
  if (!s || s <= 0) return 'â€”';
  if (s < 60) return Math.round(s) + 'ç§’';
  const m = Math.floor(s / 60), sec = Math.round(s % 60);
  return sec > 0 ? `${m}åˆ†${sec}ç§’` : `${m}åˆ†é’Ÿ`;
}

function showError(msg) {
  const b = document.getElementById('errorBar');
  b.textContent = 'âš ï¸ ' + msg;
  b.classList.add('show');
}
function hideError() { document.getElementById('errorBar').classList.remove('show'); }

function showProgress() { document.getElementById('progressSection').classList.add('show'); }
function hideProgress() {
  document.getElementById('progressSection').classList.remove('show');
  if (elapsedTimer) { clearInterval(elapsedTimer); elapsedTimer = null; }
}

function startTimer() {
  startTime = Date.now();
  elapsedTimer = setInterval(() => {
    document.getElementById('statElapsed').textContent = fmt((Date.now() - startTime) / 1000);
  }, 1000);
}

function updateProgress(status) {
  const elapsed = (Date.now() - startTime) / 1000;
  const estimated = status.estimated_duration || 400;
  const remaining = Math.max(0, estimated - elapsed);
  const pct = Math.min(93, status.progress || Math.min(90, elapsed / estimated * 100));
  document.getElementById('statElapsed').textContent = fmt(elapsed);
  document.getElementById('statRemaining').textContent = fmt(remaining);
  document.getElementById('statTotal').textContent = fmt(estimated);
  document.getElementById('progressBarFill').style.width = pct + '%';
  const stepMap = {
    pending:'æ­£åœ¨æ’é˜Ÿç­‰å¾…â€¦â€¦', running:'åˆ†æè¿›è¡Œä¸­â€¦â€¦',
    technical:'ğŸ“Š å¸‚åœºæŠ€æœ¯åˆ†æâ€¦â€¦', fundamental:'ğŸ“‹ åŸºæœ¬é¢æ·±åº¦åˆ†æâ€¦â€¦',
    news:'ğŸ“° æ–°é—»èˆ†æƒ…åˆ†æâ€¦â€¦', social_media:'ğŸ’¬ ç¤¾åª’æƒ…ç»ªåˆ†æâ€¦â€¦',
    bull:'ğŸ“ˆ å¤šå¤´ç ”ç©¶å‘˜åˆ†æâ€¦â€¦', bear:'ğŸ“‰ ç©ºå¤´ç ”ç©¶å‘˜åˆ†æâ€¦â€¦',
    debate:'âš–ï¸ å¤šç©ºè¾©è®ºä¸­â€¦â€¦', decision:'ğŸ¯ ç ”ç©¶ç»ç†å†³ç­–â€¦â€¦',
    aggressive:'âš¡ æ¿€è¿›åˆ†æå¸ˆè¯„ä¼°â€¦â€¦', conservative:'ğŸ›¡ï¸ ä¿å®ˆåˆ†æå¸ˆè¯„ä¼°â€¦â€¦',
    neutral:'âš–ï¸ ä¸­æ€§åˆ†æå¸ˆè¯„ä¼°â€¦â€¦', portfolio:'ğŸ’¼ æŠ•èµ„ç»„åˆç»ç†å†³ç­–â€¦â€¦',
    finalizing:'âœ… ç»¼åˆç ”åˆ¤ä¸­â€¦â€¦', failed:'åˆ†æå¤±è´¥',
  };
  const step = status.current_step || status.current_phase || 'running';
  document.getElementById('currentStepText').textContent = stepMap[step] || step + 'â€¦â€¦';
}

async function apiLogin() {
  const res = await fetch(`${API_BASE}/api/auth/login`, {
    method: 'POST', headers: {'Content-Type':'application/json'},
    body: JSON.stringify({username: ADMIN_USER, password: ADMIN_PASS})
  });
  if (!res.ok) throw new Error('ç™»å½•å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
  const d = await res.json();
  return d.data?.access_token || d.access_token;
}

async function apiSubmit(stockCode, market, depth) {
  const mMap = {CN:'Aè‚¡', HK:'æ¸¯è‚¡', US:'ç¾è‚¡'};
  const dMap = {quick:'å¿«é€Ÿ', deep:'æ·±åº¦'};
  const today = new Date().toISOString().slice(0,10);
  const res = await fetch(`${API_BASE}/api/analysis/single`, {
    method: 'POST',
    headers: {'Content-Type':'application/json', 'Authorization':`Bearer ${authToken}`},
    body: JSON.stringify({
      symbol: stockCode, stock_code: stockCode,
      parameters: {
        market_type: mMap[market] || 'Aè‚¡', analysis_date: today,
        research_depth: dMap[depth] || 'æ·±åº¦',
        analysts: ['market','fundamentals','news','social_media'],
        llm_provider: 'deepseek',
        quick_thinking_llm: 'deepseek-chat', deep_thinking_llm: 'deepseek-chat'
      }
    })
  });
  if (!res.ok) { const e = await res.json().catch(()=>({})); throw new Error(e.detail || e.message || 'æäº¤å¤±è´¥'); }
  const d = await res.json();
  return d.data?.task_id || d.task_id;
}

async function apiStatus(taskId) {
  const res = await fetch(`${API_BASE}/api/analysis/tasks/${taskId}/status`, {headers:{'Authorization':`Bearer ${authToken}`}});
  if (!res.ok) throw new Error('è·å–çŠ¶æ€å¤±è´¥');
  const d = await res.json(); return d.data || d;
}

async function apiResult(taskId) {
  const res = await fetch(`${API_BASE}/api/analysis/tasks/${taskId}/result`, {headers:{'Authorization':`Bearer ${authToken}`}});
  if (!res.ok) throw new Error('è·å–ç»“æœå¤±è´¥');
  const d = await res.json(); return d.data || d;
}

function cls(sig) {
  if (!sig) return 'hold';
  const s = String(sig).toLowerCase();
  if (s.includes('ä¹°') || s.includes('buy') || s.includes('å¢æŒ')) return 'buy';
  if (s.includes('å–') || s.includes('sell') || s.includes('å‡æŒ')) return 'sell';
  return 'hold';
}

function extract(obj) {
  if (!obj) return '';
  if (typeof obj === 'string') return obj.trim();
  return (obj.analysis || obj.content || obj.reasoning || obj.summary || obj.report || obj.text || '').trim();
}

function fmtContent(raw) {
  if (!raw) return '';
  return raw
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
    .replace(/### (.+)/g,'<h3>$1</h3>')
    .replace(/#### (.+)/g,'<h4>$1</h4>')
    .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
    .replace(/\n/g,'<br>');
}

function buildSections(r) {
  return [
    {icon:'ğŸ“Š', title:'å¸‚åœºæŠ€æœ¯åˆ†æ', content: extract(r.market_analysis || r.technical_analysis)},
    {icon:'ğŸ“‹', title:'åŸºæœ¬é¢åˆ†æ',   content: extract(r.fundamental_analysis)},
    {icon:'ğŸ“°', title:'æ–°é—»èˆ†æƒ…',     content: extract(r.news_analysis)},
    {icon:'ğŸ’¬', title:'ç¤¾åª’æƒ…ç»ª',     content: extract(r.sentiment_analysis || r.social_media_analysis)},
    {icon:'ğŸ“ˆ', title:'å¤šå¤´ç ”ç©¶å‘˜',   content: extract(r.bull_analyst || r.bull_analysis || r.bull_researcher)},
    {icon:'ğŸ“‰', title:'ç©ºå¤´ç ”ç©¶å‘˜',   content: extract(r.bear_analyst || r.bear_analysis || r.bear_researcher)},
    {icon:'ğŸ¯', title:'ç ”ç©¶ç»ç†å†³ç­–', content: extract(r.research_manager || r.manager_decision)},
    {icon:'âš¡', title:'æ¿€è¿›åˆ†æå¸ˆ',   content: extract(r.aggressive_analyst || r.aggressive_analysis)},
    {icon:'ğŸ›¡ï¸', title:'ä¿å®ˆåˆ†æå¸ˆ',   content: extract(r.conservative_analyst || r.conservative_analysis)},
    {icon:'âš–ï¸', title:'ä¸­æ€§åˆ†æå¸ˆ',   content: extract(r.neutral_analyst || r.neutral_analysis)},
    {icon:'ğŸ’¼', title:'æŠ•èµ„ç»„åˆç»ç†', content: extract(r.portfolio_manager || r.portfolio_analysis)},
    {icon:'ğŸ', title:'æœ€ç»ˆäº¤æ˜“å†³ç­–', content: extract(r.final_decision?.reasoning || r.final_trade_decision)},
  ].filter(s => s.content);
}

function toggleSec(i) {
  const bd = document.getElementById('bd'+i), hd = document.getElementById('hd'+i), ar = document.getElementById('ar'+i);
  const open = bd.classList.contains('open');
  bd.classList.toggle('open', !open);
  hd.classList.toggle('open', !open);
  ar.classList.toggle('open', !open);
}

function renderResult(result, stockCode) {
  currentResult = result;
  document.getElementById('resultSection').classList.add('show');
  const name = result.stock_name || result.name || stockCode;
  document.getElementById('resultStockName').textContent = `${name}ï¼ˆ${stockCode}ï¼‰`;
  document.getElementById('resultMeta').textContent = `${new Date().toLocaleDateString('zh-CN')} Â· AIå¤šæ™ºèƒ½ä½“åˆ†æ`;

  const dec = result.final_decision || result.decision || {};
  const action = dec.action || dec.signal || dec.recommendation || '';
  if (action) {
    document.getElementById('signalRow').innerHTML = `<div class="signal-tag ${cls(action)}"><div class="signal-dot"></div>ç»¼åˆä¿¡å·ï¼š${action}</div>`;
  }

  const verdict = dec.reasoning || result.summary || result.conclusion || result.analysis_summary || '';
  document.getElementById('verdictText').textContent = verdict || 'åˆ†æå®Œæˆï¼Œè¯·æŸ¥çœ‹ä¸‹æ–¹å„æ¨¡å—è¯¦æƒ…ã€‚';

  const sections = buildSections(result);
  const container = document.getElementById('sectionsContainer');
  container.innerHTML = '';
  sections.forEach((sec, i) => {
    const div = document.createElement('div');
    div.className = 'section-card';
    div.innerHTML = `
      <div class="section-hd" id="hd${i}" onclick="toggleSec(${i})">
        <span class="section-icon">${sec.icon}</span>
        <span class="section-title">${sec.title}</span>
        <span class="section-arrow" id="ar${i}">â–¼</span>
      </div>
      <div class="section-bd" id="bd${i}">
        <div class="section-content">${fmtContent(sec.content)}</div>
      </div>`;
    container.appendChild(div);
  });

  const advice = dec.investment_advice || dec.advice || result.investment_advice || '';
  if (advice) {
    document.getElementById('investCard').style.display = 'block';
    document.getElementById('investText').textContent = advice;
  }
}

async function downloadPDF() {
  if (!currentResult) return;
  const btn = document.getElementById('downloadBtn');
  const orig = btn.innerHTML;
  btn.textContent = 'ç”Ÿæˆä¸­â€¦â€¦';
  btn.disabled = true;
  try {
    const {jsPDF} = window.jspdf;
    const doc = new jsPDF({orientation:'portrait', unit:'mm', format:'a4'});
    const stockName = document.getElementById('resultStockName').textContent;
    const dateStr = new Date().toLocaleDateString('zh-CN');
    const W = doc.internal.pageSize.getWidth(), M = 18, maxW = W - M*2;
    let y = M;

    const add = (text, size, bold, rgb, indent) => {
      doc.setFontSize(size || 10);
      doc.setFont('helvetica', bold ? 'bold' : 'normal');
      doc.setTextColor(...(rgb || [60,60,60]));
      const lines = doc.splitTextToSize(String(text||''), maxW - (indent||0));
      lines.forEach(l => {
        if (y > 272) { doc.addPage(); y = M; }
        doc.text(l, M + (indent||0), y);
        y += (size || 10) * 0.52;
      });
      y += 2;
    };

    // å°é¢
    add('AI å¤šæ™ºèƒ½ä½“æŠ•ç ”åˆ†ææŠ¥å‘Š', 17, true, [44,44,44]);
    add(stockName, 13, false, [139,111,71]);
    add(`ç”Ÿæˆæ—¥æœŸï¼š${dateStr}`, 9, false, [136,136,136]);
    y += 3;
    add('ã€å…è´£å£°æ˜ã€‘æ­¤ç³»ç»Ÿä»…ä¾› AI æŠ€æœ¯æ¼”ç¤ºï¼Œä¸æä¾›ä»»ä½•æŠ•èµ„å»ºè®®ï¼Œåˆ‡å‹¿å½“çœŸï¼', 9, true, [184,84,80]);
    y += 5;

    const sections = buildSections(currentResult);
    sections.forEach(sec => {
      y += 3;
      add(`${sec.icon} ${sec.title}`, 11, true, [139,111,71]);
      add(sec.content.replace(/<[^>]+>/g,'').replace(/&lt;/g,'<').replace(/&gt;/g,'>').replace(/&amp;/g,'&'), 9, false, null, 2);
    });

    if (y > 250) { doc.addPage(); y = M; }
    y += 6;
    add('âš ï¸ é‡è¦å…è´£å£°æ˜', 10, true, [184,84,80]);
    add('æ­¤ç³»ç»Ÿä»…ä¾› AI æŠ€æœ¯æ¼”ç¤ºï¼Œä¸æä¾›ä»»ä½•æŠ•èµ„å»ºè®®ï¼Œåˆ‡å‹¿å½“çœŸï¼ä»¥ä¸Šå…¨éƒ¨å†…å®¹ç”± AI å¤šæ™ºèƒ½ä½“ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆï¼Œä¸æ„æˆä»»ä½•å½¢å¼çš„æŠ•èµ„å»ºè®®æˆ–æ¨èã€‚è‚¡ç¥¨æŠ•èµ„æœ‰é£é™©ï¼Œå¸‚åœºæƒ…å†µéšæ—¶å˜åŒ–ï¼Œä»»ä½•æŠ•èµ„å†³ç­–è¯·ç»“åˆè‡ªèº«æƒ…å†µï¼Œå¹¶å’¨è¯¢ä¸“ä¸šæŒç‰ŒæŠ•èµ„é¡¾é—®ã€‚', 9, false, [184,84,80]);

    doc.save(`æŠ•ç ”æŠ¥å‘Š_${currentStockCode}_${dateStr}.pdf`);
  } catch(e) {
    alert('PDFç”Ÿæˆå¤±è´¥ï¼š' + e.message);
  } finally {
    btn.innerHTML = orig;
    btn.disabled = false;
  }
}

async function startAnalysis() {
  const stockCode = document.getElementById('stockInput').value.trim();
  const market = document.getElementById('marketSelect').value;
  const depth = document.getElementById('depthSelect').value;
  if (!stockCode) { showError('è¯·è¾“å…¥è‚¡ç¥¨ä»£ç æˆ–åç§°'); return; }
  currentStockCode = stockCode;
  hideError();
  document.getElementById('resultSection').classList.remove('show');
  document.getElementById('analyzeBtn').disabled = true;
  showProgress();
  startTimer();

  try {
    document.getElementById('progressTitle').textContent = 'æ­£åœ¨éªŒè¯èº«ä»½â€¦â€¦';
    document.getElementById('currentStepText').textContent = 'ç™»å½•éªŒè¯ä¸­â€¦â€¦';
    if (!authToken) authToken = await apiLogin();

    document.getElementById('currentStepText').textContent = 'æäº¤åˆ†æä»»åŠ¡ä¸­â€¦â€¦';
    const taskId = await apiSubmit(stockCode, market, depth);
    if (!taskId) throw new Error('æœªè·å–åˆ°ä»»åŠ¡IDï¼Œè¯·é‡è¯•');
    document.getElementById('progressTitle').textContent = 'åˆ†æè¿›è¡Œä¸­â€¦â€¦';

    let attempts = 0;
    while (attempts < 200) {
      await sleep(5000);
      const status = await apiStatus(taskId);
      updateProgress(status);
      if (status.status === 'completed' || status.status === 'success') {
        document.getElementById('currentStepText').textContent = 'âœ… åˆ†æå®Œæˆï¼Œæ­£åœ¨åŠ è½½ç»“æœâ€¦â€¦';
        document.getElementById('progressBarFill').style.width = '100%';
        await sleep(600);
        const result = await apiResult(taskId);
        hideProgress();
        renderResult(result, stockCode);
        break;
      }
      if (status.status === 'failed' || status.status === 'error') {
        throw new Error(status.error_message || 'åˆ†æä»»åŠ¡å¤±è´¥ï¼Œè¯·é‡è¯•');
      }
      attempts++;
    }
    if (attempts >= 200) throw new Error('åˆ†æè¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•');
  } catch(err) {
    hideProgress();
    if (err.message.includes('401')) authToken = null;
    showError(err.message);
  } finally {
    document.getElementById('analyzeBtn').disabled = false;
  }
}

document.getElementById('stockInput').addEventListener('keydown', e => {
  if (e.key === 'Enter') startAnalysis();
});
</script>
</body>
</html>
